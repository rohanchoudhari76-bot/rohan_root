#!/bin/bash

# Check before locking $0, as the first user has exclusive lock privileges
if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root (use sudo or su)"
  exit 1
fi
# try to acquire exclusive lock, if failed exit with code 254
[ "${SBA_FLOCKER}" != "$0" ] && exec env SBA_FLOCKER="$0" flock -E 254 -en "/tmp/sbalinux-install.lock" "$0" "$@" || :

set -euo pipefail

[[ ! -z ${SBA_INSTALLER_DEBUG:=""} ]] && set -x

# force english localization for package manager
export LANGUAGE=en_US:en

# script version placeholder should be replaced by CI pipeline
SCRIPT_VER='1.26.8'

# offline package metadata
PACKAGE_DISPLAY_NAME="__CP_PACKAGE_NAME__"
PACKAGE_ID="__CP_PACKAGE_ID__"
PACKAGE_TYPE="__CP_PACKAGE_TYPE__"
PACKAGE_DISTRO="__CP_PACKAGE_DISTRO__"
PACKAGE_FEATURES="__CP_PACKAGE_BLADE_MASK__"
PACKAGE_PLATFORM="__CP_PACKAGE_PLATFORM__"

# embedded arguments to be filled by the management server providing the script, __CP_*__ place holders should be replaced with valid values
# >>REPLACE START
EMBEDDED_MGMT_FQDN='Rohan-3f7214b4-hap4.epmgmt.checkpoint.com'
EMBEDDED_MGMT_KEY='__CP_MGMT_KEY__'
EMBEDDED_MGMT_CA_CERT='LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUdyRENDQlpTZ0F3SUJBZ0lKQU51VHd1SGF1UDRFTUEwR0NTcUdTSWIzRFFFQkN3VUFNSUcwTVFzd0NRWUQKVlFRR0V3SlZVekVRTUE0R0ExVUVDQk1IUVhKcGVtOXVZVEVUTUJFR0ExVUVCeE1LVTJOdmRIUnpaR0ZzWlRFYQpNQmdHQTFVRUNoTVJSMjlFWVdSa2VTNWpiMjBzSUVsdVl5NHhMVEFyQmdOVkJBc1RKR2gwZEhBNkx5OWpaWEowCmN5NW5iMlJoWkdSNUxtTnZiUzl5WlhCdmMybDBiM0o1THpFek1ERUdBMVVFQXhNcVIyOGdSR0ZrWkhrZ1UyVmoKZFhKbElFTmxjblJwWm1sallYUmxJRUYxZEdodmNtbDBlU0F0SUVjeU1CNFhEVEl4TURreE9UQTNNVFV5TTFvWApEVEl5TVRBeU1UQTNNVFV5TTFvd0lqRWdNQjRHQTFVRUF3d1hLaTVsY0cxbmJYUXVZMmhsWTJ0d2IybHVkQzVqCmIyMHdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEQ0h0TTgzSEp4NUk0ZEFHVGoKWlFlOXIzK1JVQTkvSEZiMzMvWmtqQ0lTTjNibFJCZU5xOCtTL1VRaENQNXpNdHFxdElOTGpIb213UFZWV3NzSQpxZzZmOEFJMGZnY0c4WjlyMDllRVlCcHQ4a3Q2bm0vMmEveHNCUnptNmZDYTFNL3FWOWdHV2FBUmZ3N2tRMEkvCjJtemdYRmJwWFVJd1VyOWNWZ2VEZStDc3Q3dVdPQmJmVm1MRVRKUmVML3psUzlmME11c0VpR2RNQWVGMVp3NGwKNWRtY2ZydnNZUzRJSU8rNVVEU0c2b1ExTjNGNnk1TUxiUUppRmNRUks4NGNUTW9ud2pVVWVqbDQ2WFpjL21HZwpERTlnT2p4SFBWa0s3YnliZjdGUDc2cU0zK1JzMG5ueGFhMVVhSU5MOGI0bTQrUUZpcGpNSlRDVkpOTHNxYlpOCm9BM3JBZ01CQUFHamdnTlFNSUlEVERBTUJnTlZIUk1CQWY4RUFqQUFNQjBHQTFVZEpRUVdNQlFHQ0NzR0FRVUYKQndNQkJnZ3JCZ0VGQlFjREFqQU9CZ05WSFE4QkFmOEVCQU1DQmFBd09BWURWUjBmQkRFd0x6QXRvQ3VnS1lZbgphSFIwY0RvdkwyTnliQzVuYjJSaFpHUjVMbU52YlM5blpHbG5Nbk14TFRNek1EUXVZM0pzTUYwR0ExVWRJQVJXCk1GUXdTQVlMWUlaSUFZYjliUUVIRndFd09UQTNCZ2dyQmdFRkJRY0NBUllyYUhSMGNEb3ZMMk5sY25ScFptbGoKWVhSbGN5NW5iMlJoWkdSNUxtTnZiUzl5WlhCdmMybDBiM0o1THpBSUJnWm5nUXdCQWdFd2RnWUlLd1lCQlFVSApBUUVFYWpCb01DUUdDQ3NHQVFVRkJ6QUJoaGhvZEhSd09pOHZiMk56Y0M1bmIyUmhaR1I1TG1OdmJTOHdRQVlJCkt3WUJCUVVITUFLR05HaDBkSEE2THk5alpYSjBhV1pwWTJGMFpYTXVaMjlrWVdSa2VTNWpiMjB2Y21Wd2IzTnAKZEc5eWVTOW5aR2xuTWk1amNuUXdId1lEVlIwakJCZ3dGb0FVUU1LOUo0N01OSU13b2pQWCsyeXo4TFFzZ000dwpPUVlEVlIwUkJESXdNSUlYS2k1bGNHMW5iWFF1WTJobFkydHdiMmx1ZEM1amIyMkNGV1Z3YldkdGRDNWphR1ZqCmEzQnZhVzUwTG1OdmJUQWRCZ05WSFE0RUZnUVV0TUpteVdDWmdWeXAvZG9kaWszUGRjNUs4SGN3Z2dGL0Jnb3IKQmdFRUFkWjVBZ1FDQklJQmJ3U0NBV3NCYVFCMkFDbDV2dkNlT1RraDhGWnpuMk9sZCtXK1YzMmNZQXI0K1UxZApKbHdsWGNlRUFBQUJlL3pwMENjQUFBUURBRWN3UlFJZ0ZOd0djWG5rQ2ZiZXNldTRGb2lqSXZFRnY2YXlKczFsCnUzM1RNbG8zemVvQ0lRRHd4M1I3Tk9ib1A1dXBoTy94L242RjlWTXRBZUNlU1BmQ3JZeDVrektsWXdCMkFOK2wKWHF0b2drOGZiSzN1dUY5T1BscnF6YUlTcEdwZWpqc1N3Q0JFWENwekFBQUJlL3pwMGtzQUFBUURBRWN3UlFJZwpWZitHRVdGUGtJdjhIanZOYkZ0WU0zNFdDVHZHaHNhbGt3V3BmT2JNTE4wQ0lRQ0RaR1dNa2I0QTBUUkhXbXMrCkEzNGtkSlhqUTgzVlRTS09zUWsweXNGYmN3QjNBRUhJeXJIZklrWktFTWFoT2dsQ2gxNU9NWXNiQSt2clM4ZG8KOEpCaWxnYjJBQUFCZS96cDBzOEFBQVFEQUVnd1JnSWhBT2IvNklWZm5lVHBsSlNSVEQ4b2krTXhCdFNFT1BXNgpmd0l4WGZ4Kyt2cUNBaUVBdzVSeFJkOTBkUUpmU2l2azhSVjZiUDVuWUM4UzlWdFNyYlNYVG5KRFBCa3dEUVlKCktvWklodmNOQVFFTEJRQURnZ0VCQUhIUXhGdlU1SENwNERwS2tGQ2xBbGxRQ1NQWmtNc04rL3BVemVlbHFUNG0KcjJxUTI5Y056a1dkV3poTnZHeFVFQWMvWnRtVDZCWjdBUG9YRURiczdXODlRWURra3RndW9zQmhtS2FKMXJjMgpTMFNUQk43NXh3SFc0ZjZxYy94Q1VxbU5BNU0yNTRYQVZMWGFtZDlSQXVIQjQrL25YbnVtN2YzS3pSdHJyN3pyCnlCdWtmQU9OMHFpMXJEMStsdGtxT3JRWDhUcDFhZWZHMmJFZHpjQm05S3J4UW5nWWxCTTNabFhBRkNocDNxR1cKRnJSVVBGbWZZcFRra2hYYVpmQ05vMFBDdDNHWGpaL2R0aVkrMXVhMVc4SlYwMnN6d3Fkbk5aQVFldmtaV1YwdwoyRW85Y1R0Zzk2TjZ1NmR5SWRwR0ZvbmdhM0kwWHpyM1pOdnBuZDlNc0tNPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlFMERDQ0E3aWdBd0lCQWdJQkJ6QU5CZ2txaGtpRzl3MEJBUXNGQURDQmd6RUxNQWtHQTFVRUJoTUNWVk14CkVEQU9CZ05WQkFnVEIwRnlhWHB2Ym1FeEV6QVJCZ05WQkFjVENsTmpiM1IwYzJSaGJHVXhHakFZQmdOVkJBb1QKRVVkdlJHRmtaSGt1WTI5dExDQkpibU11TVRFd0x3WURWUVFERXloSGJ5QkVZV1JrZVNCU2IyOTBJRU5sY25ScApabWxqWVhSbElFRjFkR2h2Y21sMGVTQXRJRWN5TUI0WERURXhNRFV3TXpBM01EQXdNRm9YRFRNeE1EVXdNekEzCk1EQXdNRm93Z2JReEN6QUpCZ05WQkFZVEFsVlRNUkF3RGdZRFZRUUlFd2RCY21sNmIyNWhNUk13RVFZRFZRUUgKRXdwVFkyOTBkSE5rWVd4bE1Sb3dHQVlEVlFRS0V4RkhiMFJoWkdSNUxtTnZiU3dnU1c1akxqRXRNQ3NHQTFVRQpDeE1rYUhSMGNEb3ZMMk5sY25SekxtZHZaR0ZrWkhrdVkyOXRMM0psY0c5emFYUnZjbmt2TVRNd01RWURWUVFECkV5cEhieUJFWVdSa2VTQlRaV04xY21VZ1EyVnlkR2xtYVdOaGRHVWdRWFYwYUc5eWFYUjVJQzBnUnpJd2dnRWkKTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDNTRNc1ExSzkydmRTVFl1c3daTGlCQ0d6RApCTmxpRjQ0di96NWx6NC9PWXVZOFVoemFGa1ZMVmF0NGEyT0RZcERPRDJsc21jZ2FGSXRNekVVejZvamNucU92CksvNkFZWjE1VjhUUEx2US9NRHhkUi95YUZyekRONVpCVVk0UlMxVDRLTDdRakw3d01EZ2U4N0FtK0daSFkyM2UKY1NaSGp6aEhVOUZHSGJUajNBRHFSYXk5dkhIWnFtOEEyOXZOTURwNVQxOU1SL2dkNzF2Q3hKMWdPN0d5UTVIWQpwRE5PNnJQV0owK3RKWXFseHZUVjBLYXVkQVZrVjRpMVJGWFVMU282UHZpNHZla3lDZ0tVWk1RV09sRHhTcTduCmVUT3ZEQ0FIZitqZkJEbkNhUUpzWTFMNmQ4RWJ5SFNIeUxtVEdGQlVOVXRwVHJ3NzAwa3VIOXpCMGxMN0FnTUIKQUFHamdnRWFNSUlCRmpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUE0R0ExVWREd0VCL3dRRUF3SUJCakFkQmdOVgpIUTRFRmdRVVFNSzlKNDdNTklNd29qUFgrMnl6OExRc2dNNHdId1lEVlIwakJCZ3dGb0FVT3BxRkJ4Qm5LTGJ2CjlyMEZRVzRnd1pUYUQ5NHdOQVlJS3dZQkJRVUhBUUVFS0RBbU1DUUdDQ3NHQVFVRkJ6QUJoaGhvZEhSd09pOHYKYjJOemNDNW5iMlJoWkdSNUxtTnZiUzh3TlFZRFZSMGZCQzR3TERBcW9DaWdKb1lrYUhSMGNEb3ZMMk55YkM1bgpiMlJoWkdSNUxtTnZiUzluWkhKdmIzUXRaekl1WTNKc01FWUdBMVVkSUFRL01EMHdPd1lFVlIwZ0FEQXpNREVHCkNDc0dBUVVGQndJQkZpVm9kSFJ3Y3pvdkwyTmxjblJ6TG1kdlpHRmtaSGt1WTI5dEwzSmxjRzl6YVhSdmNua3YKTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBSWZteVRFTWc0dUphcGtFdi9vVjlQQk85c1BweUlCc2xRajZaego5MWN4Rzc2ODVDL2IrTHJUVytDMDUrWjVZZzRNb3RkcVkzTXh0ZldvU0tRN0NDMmlYWkRYdEh3bFR4RldNTVMyClJKMTdMSjNsWHVidkRHR3F2K1FxRys2RW5yaURmY0ZEemtTbkUzQU5rUi8weUJPdGcyRFoySEtvY3lRZXRhd2kKRHNvWGlXSllSQnVyaVNVQkFBL054QnRpMjFHMDB3OVJLcHYwdkhQOGRzNDJwTTNaMkN6cXJwdjFLcktRMFUxMQpHSW8vaWtHUUkzMWJTLzZrQTFpYlJyTERZR0NEK0gxUVFjN0NvWkREdSs4Q0w5SVZWTzVFRmRrS3JxZUtNKzJ4CkxYWTJKdHdFNjUvM1lSOFYzSWR2N2thV0tLMmhKbjBLQ2FjdUJLT052UGk4QkRBQgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlFZlRDQ0EyV2dBd0lCQWdJREcrY1ZNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1HTXhDekFKQmdOVkJBWVRBbFZUCk1TRXdId1lEVlFRS0V4aFVhR1VnUjI4Z1JHRmtaSGtnUjNKdmRYQXNJRWx1WXk0eE1UQXZCZ05WQkFzVEtFZHYKSUVSaFpHUjVJRU5zWVhOeklESWdRMlZ5ZEdsbWFXTmhkR2x2YmlCQmRYUm9iM0pwZEhrd0hoY05NVFF3TVRBeApNRGN3TURBd1doY05NekV3TlRNd01EY3dNREF3V2pDQmd6RUxNQWtHQTFVRUJoTUNWVk14RURBT0JnTlZCQWdUCkIwRnlhWHB2Ym1FeEV6QVJCZ05WQkFjVENsTmpiM1IwYzJSaGJHVXhHakFZQmdOVkJBb1RFVWR2UkdGa1pIa3UKWTI5dExDQkpibU11TVRFd0x3WURWUVFERXloSGJ5QkVZV1JrZVNCU2IyOTBJRU5sY25ScFptbGpZWFJsSUVGMQpkR2h2Y21sMGVTQXRJRWN5TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF2M0ZpCkNQSDZXVFQzRzhrWW8vZUFTVmpwSW9NVHBzVWdRd0U3aFBIbWhVbWZKK3IyaEJ0T29MVGJjSmpITWdHeEJUNEgKVHU3MCtrOHZXVEFpNTZzWlZtdmlnQWY4OHhaMWdEbFJlK1g1TmJaMFRxbU5naFBrdGorcEE0UDZvcjZLRldwLwozZ3ZEdGhrVUJjcnF3NmdFbER0R2ZESU44d0JtSXNpTmFXMDJqQkVZdDlPeUhHQzBPUG9Dak03VDNVWUgzZ28rCjYxMTh5SHo3c0N0VHBKSmlhVkVsQldFYVJJR01MS2xEbGlQZnJEcUJtZzRweFJ5cDZWMGV0cDZlTUFvNXp2R0kKZ1B0TFhjd3k3SVZpUXlVMEFsWW5BWkcwTzNBcVAyNng2SnlJQVgyZjFQbmJVMjFnbmI4czUxaXJ1RjlHL003RQpHd004Q2V0Sk1WeHBSclBnUndJREFRQUJvNElCRnpDQ0FSTXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU9CZ05WCkhROEJBZjhFQkFNQ0FRWXdIUVlEVlIwT0JCWUVGRHFhaFFjUVp5aTI3L2E5QlVGdUlNR1UyZy9lTUI4R0ExVWQKSXdRWU1CYUFGTkxFc05LUjFFd1JjYk5oeXoyaC90Mm9hdFRqTURRR0NDc0dBUVVGQndFQkJDZ3dKakFrQmdncgpCZ0VGQlFjd0FZWVlhSFIwY0RvdkwyOWpjM0F1WjI5a1lXUmtlUzVqYjIwdk1ESUdBMVVkSHdRck1Da3dKNkFsCm9DT0dJV2gwZEhBNkx5OWpjbXd1WjI5a1lXUmtlUzVqYjIwdloyUnliMjkwTG1OeWJEQkdCZ05WSFNBRVB6QTkKTURzR0JGVWRJQUF3TXpBeEJnZ3JCZ0VGQlFjQ0FSWWxhSFIwY0hNNkx5OWpaWEowY3k1bmIyUmhaR1I1TG1OdgpiUzl5WlhCdmMybDBiM0o1THpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQVdRdFR2WktHRWFja2UrMWJNYzhkCkgyeHd4Ymh1dms2NzlyNlhVT0V3Zjdvb1hHS1V3dU4rTS9mN1FuYUYyNVVjakNKWWRRa01pR1ZuT1FvV0NjV2cKT0pla3hTT1RQN1FZcGdFR1JKSGpwMmtudEZvbGZ6cTNNczNkaFA4cU9Da3pwTjFuc29YK29ZZ2dIRkNKeU53cQo5a0lETjB6bWlOL1ZyeVR5c2NQZnpMWHM0SmxldDBsVUlEeVVHQXpISEZJWVNhUnQ0Yk5ZQzhuWTdObXVIREtPCktIQU40djZtRjU2RUQ3MVhjTE5hNlIrZ2hsTzc3M3ovYVF2Z1NNTzNrd3ZJQ2xURXJGMFVaemRzeXFVdk1RZzMKcW01dmpMeWI0bGRkSklHdmw1ZWNoSzFzckRkTVp2TmhrUkVnNUw0d24zcWtLUW13NFRSZlpIY1lRRkhmakRDbQpydz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBRENDQXVpZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRVUZBREJqTVFzd0NRWURWUVFHRXdKVlV6RWgKTUI4R0ExVUVDaE1ZVkdobElFZHZJRVJoWkdSNUlFZHliM1Z3TENCSmJtTXVNVEV3THdZRFZRUUxFeWhIYnlCRQpZV1JrZVNCRGJHRnpjeUF5SUVObGNuUnBabWxqWVhScGIyNGdRWFYwYUc5eWFYUjVNQjRYRFRBME1EWXlPVEUzCk1EWXlNRm9YRFRNME1EWXlPVEUzTURZeU1Gb3dZekVMTUFrR0ExVUVCaE1DVlZNeElUQWZCZ05WQkFvVEdGUm8KWlNCSGJ5QkVZV1JrZVNCSGNtOTFjQ3dnU1c1akxqRXhNQzhHQTFVRUN4TW9SMjhnUkdGa1pIa2dRMnhoYzNNZwpNaUJEWlhKMGFXWnBZMkYwYVc5dUlFRjFkR2h2Y21sMGVUQ0NBU0F3RFFZSktvWklodmNOQVFFQkJRQURnZ0VOCkFEQ0NBUWdDZ2dFQkFONmQxK3BYR0VtaFcrdlhYMGlHNnI3ZC8rVHZaeHowWldpelYzR2dYbmU3N1p0SjZYQ0EKUFZZWVl3aHYydkxNMEQ5L0FsUWlWQkRZc29IVXdIVTlTMy9IZDhNK2VLc2FBN1VnYXk5cUs3SEZpSDdFdXg2dwp3ZGhGSjIrcU4xajNoeWJYMkMzMnFSZTNIM0kyVHFZWFAyV1lrdHNxYmwyaS9vamdDOTUvNVkwVjRldkxPdFhpCkVxSVRMZGlPcjE4U1BhQUlCUWkyWEtWbE9BUkZtUjZqWUdCMHhVR2xjbUliWXNVZmIxOGFRcjRDVVdXb3JpTVkKYXZ4NEE2bE5mNEREK3F0YS9LRkFwTW9aRnY2eXlPOWVjdzN1ZDcyYTlubVl2TEVIWjZJVkRkMmdXTVpFZXdvKwpZaWhmdWtFSFUxalBFWDQ0ZE1YNC83VnBrSStFZE9xWEc2OENBUU9qZ2NBd2diMHdIUVlEVlIwT0JCWUVGTkxFCnNOS1IxRXdSY2JOaHl6MmgvdDJvYXRUak1JR05CZ05WSFNNRWdZVXdnWUtBRk5MRXNOS1IxRXdSY2JOaHl6MmgKL3Qyb2F0VGpvV2VrWlRCak1Rc3dDUVlEVlFRR0V3SlZVekVoTUI4R0ExVUVDaE1ZVkdobElFZHZJRVJoWkdSNQpJRWR5YjNWd0xDQkpibU11TVRFd0x3WURWUVFMRXloSGJ5QkVZV1JrZVNCRGJHRnpjeUF5SUVObGNuUnBabWxqCllYUnBiMjRnUVhWMGFHOXlhWFI1Z2dFQU1Bd0dBMVVkRXdRRk1BTUJBZjh3RFFZSktvWklodmNOQVFFRkJRQUQKZ2dFQkFESkw4N0xLUHBIOEVzYWhCNHlPZDZBekJoUmNrQjRZOXdpbVBRb1orWWVBRVc1cDVKWVhNUDgwa1dOeQpPTzdNSEFHakhaUW9wREgyZXNSVTEvYmxNVmdEb3N6T1l0dVVSWE8xdjBYSkpMWFZnZ0t0STNscGpiaTJUYzdQClRNb3pJK2djaUtxZGkwRnVGc2tnNVltZXpUdmFjUGQrbVNZZ0ZGUWxxMjV6aGVhYklaMEtiSUlPcVBqQ0RQb1EKSG15Vzc0Y054QTloaTYzdWd5dVYrSTZTaEhJNTZ5RHFnKzJEelpkdUNMenJUaWEyY3l2azAvWk0vaVp4NG1FUgpkRXIvVnhxSEQzVklMczlSYVJlZ0FoSmhsZFhSUUxJUVRPN0VyQkJEcHFXZUN0V1ZZcG9OejRpQ3hUSU01Q3VmClJlWU5ueWljc2JrcVdsZXROdyt2SFgvYnZaOD0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo='
EMBEDDED_MGMT_CA_CERT_SIG='MIImcwYJKoZIhvcNAQcCoIImZDCCJmACAQExDzANBglghkgBZQMEAgEFADCCHBQGCSqGSIb3DQEHAaCCHAUEghwBLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUdyRENDQlpTZ0F3SUJBZ0lKQU51VHd1SGF1UDRFTUEwR0NTcUdTSWIzRFFFQkN3VUFNSUcwTVFzd0NRWUQKVlFRR0V3SlZVekVRTUE0R0ExVUVDQk1IUVhKcGVtOXVZVEVUTUJFR0ExVUVCeE1LVTJOdmRIUnpaR0ZzWlRFYQpNQmdHQTFVRUNoTVJSMjlFWVdSa2VTNWpiMjBzSUVsdVl5NHhMVEFyQmdOVkJBc1RKR2gwZEhBNkx5OWpaWEowCmN5NW5iMlJoWkdSNUxtTnZiUzl5WlhCdmMybDBiM0o1THpFek1ERUdBMVVFQXhNcVIyOGdSR0ZrWkhrZ1UyVmoKZFhKbElFTmxjblJwWm1sallYUmxJRUYxZEdodmNtbDBlU0F0SUVjeU1CNFhEVEl4TURreE9UQTNNVFV5TTFvWApEVEl5TVRBeU1UQTNNVFV5TTFvd0lqRWdNQjRHQTFVRUF3d1hLaTVsY0cxbmJYUXVZMmhsWTJ0d2IybHVkQzVqCmIyMHdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEQ0h0TTgzSEp4NUk0ZEFHVGoKWlFlOXIzK1JVQTkvSEZiMzMvWmtqQ0lTTjNibFJCZU5xOCtTL1VRaENQNXpNdHFxdElOTGpIb213UFZWV3NzSQpxZzZmOEFJMGZnY0c4WjlyMDllRVlCcHQ4a3Q2bm0vMmEveHNCUnptNmZDYTFNL3FWOWdHV2FBUmZ3N2tRMEkvCjJtemdYRmJwWFVJd1VyOWNWZ2VEZStDc3Q3dVdPQmJmVm1MRVRKUmVML3psUzlmME11c0VpR2RNQWVGMVp3NGwKNWRtY2ZydnNZUzRJSU8rNVVEU0c2b1ExTjNGNnk1TUxiUUppRmNRUks4NGNUTW9ud2pVVWVqbDQ2WFpjL21HZwpERTlnT2p4SFBWa0s3YnliZjdGUDc2cU0zK1JzMG5ueGFhMVVhSU5MOGI0bTQrUUZpcGpNSlRDVkpOTHNxYlpOCm9BM3JBZ01CQUFHamdnTlFNSUlEVERBTUJnTlZIUk1CQWY4RUFqQUFNQjBHQTFVZEpRUVdNQlFHQ0NzR0FRVUYKQndNQkJnZ3JCZ0VGQlFjREFqQU9CZ05WSFE4QkFmOEVCQU1DQmFBd09BWURWUjBmQkRFd0x6QXRvQ3VnS1lZbgphSFIwY0RvdkwyTnliQzVuYjJSaFpHUjVMbU52YlM5blpHbG5Nbk14TFRNek1EUXVZM0pzTUYwR0ExVWRJQVJXCk1GUXdTQVlMWUlaSUFZYjliUUVIRndFd09UQTNCZ2dyQmdFRkJRY0NBUllyYUhSMGNEb3ZMMk5sY25ScFptbGoKWVhSbGN5NW5iMlJoWkdSNUxtTnZiUzl5WlhCdmMybDBiM0o1THpBSUJnWm5nUXdCQWdFd2RnWUlLd1lCQlFVSApBUUVFYWpCb01DUUdDQ3NHQVFVRkJ6QUJoaGhvZEhSd09pOHZiMk56Y0M1bmIyUmhaR1I1TG1OdmJTOHdRQVlJCkt3WUJCUVVITUFLR05HaDBkSEE2THk5alpYSjBhV1pwWTJGMFpYTXVaMjlrWVdSa2VTNWpiMjB2Y21Wd2IzTnAKZEc5eWVTOW5aR2xuTWk1amNuUXdId1lEVlIwakJCZ3dGb0FVUU1LOUo0N01OSU13b2pQWCsyeXo4TFFzZ000dwpPUVlEVlIwUkJESXdNSUlYS2k1bGNHMW5iWFF1WTJobFkydHdiMmx1ZEM1amIyMkNGV1Z3YldkdGRDNWphR1ZqCmEzQnZhVzUwTG1OdmJUQWRCZ05WSFE0RUZnUVV0TUpteVdDWmdWeXAvZG9kaWszUGRjNUs4SGN3Z2dGL0Jnb3IKQmdFRUFkWjVBZ1FDQklJQmJ3U0NBV3NCYVFCMkFDbDV2dkNlT1RraDhGWnpuMk9sZCtXK1YzMmNZQXI0K1UxZApKbHdsWGNlRUFBQUJlL3pwMENjQUFBUURBRWN3UlFJZ0ZOd0djWG5rQ2ZiZXNldTRGb2lqSXZFRnY2YXlKczFsCnUzM1RNbG8zemVvQ0lRRHd4M1I3Tk9ib1A1dXBoTy94L242RjlWTXRBZUNlU1BmQ3JZeDVrektsWXdCMkFOK2wKWHF0b2drOGZiSzN1dUY5T1BscnF6YUlTcEdwZWpqc1N3Q0JFWENwekFBQUJlL3pwMGtzQUFBUURBRWN3UlFJZwpWZitHRVdGUGtJdjhIanZOYkZ0WU0zNFdDVHZHaHNhbGt3V3BmT2JNTE4wQ0lRQ0RaR1dNa2I0QTBUUkhXbXMrCkEzNGtkSlhqUTgzVlRTS09zUWsweXNGYmN3QjNBRUhJeXJIZklrWktFTWFoT2dsQ2gxNU9NWXNiQSt2clM4ZG8KOEpCaWxnYjJBQUFCZS96cDBzOEFBQVFEQUVnd1JnSWhBT2IvNklWZm5lVHBsSlNSVEQ4b2krTXhCdFNFT1BXNgpmd0l4WGZ4Kyt2cUNBaUVBdzVSeFJkOTBkUUpmU2l2azhSVjZiUDVuWUM4UzlWdFNyYlNYVG5KRFBCa3dEUVlKCktvWklodmNOQVFFTEJRQURnZ0VCQUhIUXhGdlU1SENwNERwS2tGQ2xBbGxRQ1NQWmtNc04rL3BVemVlbHFUNG0KcjJxUTI5Y056a1dkV3poTnZHeFVFQWMvWnRtVDZCWjdBUG9YRURiczdXODlRWURra3RndW9zQmhtS2FKMXJjMgpTMFNUQk43NXh3SFc0ZjZxYy94Q1VxbU5BNU0yNTRYQVZMWGFtZDlSQXVIQjQrL25YbnVtN2YzS3pSdHJyN3pyCnlCdWtmQU9OMHFpMXJEMStsdGtxT3JRWDhUcDFhZWZHMmJFZHpjQm05S3J4UW5nWWxCTTNabFhBRkNocDNxR1cKRnJSVVBGbWZZcFRra2hYYVpmQ05vMFBDdDNHWGpaL2R0aVkrMXVhMVc4SlYwMnN6d3Fkbk5aQVFldmtaV1YwdwoyRW85Y1R0Zzk2TjZ1NmR5SWRwR0ZvbmdhM0kwWHpyM1pOdnBuZDlNc0tNPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlFMERDQ0E3aWdBd0lCQWdJQkJ6QU5CZ2txaGtpRzl3MEJBUXNGQURDQmd6RUxNQWtHQTFVRUJoTUNWVk14CkVEQU9CZ05WQkFnVEIwRnlhWHB2Ym1FeEV6QVJCZ05WQkFjVENsTmpiM1IwYzJSaGJHVXhHakFZQmdOVkJBb1QKRVVkdlJHRmtaSGt1WTI5dExDQkpibU11TVRFd0x3WURWUVFERXloSGJ5QkVZV1JrZVNCU2IyOTBJRU5sY25ScApabWxqWVhSbElFRjFkR2h2Y21sMGVTQXRJRWN5TUI0WERURXhNRFV3TXpBM01EQXdNRm9YRFRNeE1EVXdNekEzCk1EQXdNRm93Z2JReEN6QUpCZ05WQkFZVEFsVlRNUkF3RGdZRFZRUUlFd2RCY21sNmIyNWhNUk13RVFZRFZRUUgKRXdwVFkyOTBkSE5rWVd4bE1Sb3dHQVlEVlFRS0V4RkhiMFJoWkdSNUxtTnZiU3dnU1c1akxqRXRNQ3NHQTFVRQpDeE1rYUhSMGNEb3ZMMk5sY25SekxtZHZaR0ZrWkhrdVkyOXRMM0psY0c5emFYUnZjbmt2TVRNd01RWURWUVFECkV5cEhieUJFWVdSa2VTQlRaV04xY21VZ1EyVnlkR2xtYVdOaGRHVWdRWFYwYUc5eWFYUjVJQzBnUnpJd2dnRWkKTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDNTRNc1ExSzkydmRTVFl1c3daTGlCQ0d6RApCTmxpRjQ0di96NWx6NC9PWXVZOFVoemFGa1ZMVmF0NGEyT0RZcERPRDJsc21jZ2FGSXRNekVVejZvamNucU92CksvNkFZWjE1VjhUUEx2US9NRHhkUi95YUZyekRONVpCVVk0UlMxVDRLTDdRakw3d01EZ2U4N0FtK0daSFkyM2UKY1NaSGp6aEhVOUZHSGJUajNBRHFSYXk5dkhIWnFtOEEyOXZOTURwNVQxOU1SL2dkNzF2Q3hKMWdPN0d5UTVIWQpwRE5PNnJQV0owK3RKWXFseHZUVjBLYXVkQVZrVjRpMVJGWFVMU282UHZpNHZla3lDZ0tVWk1RV09sRHhTcTduCmVUT3ZEQ0FIZitqZkJEbkNhUUpzWTFMNmQ4RWJ5SFNIeUxtVEdGQlVOVXRwVHJ3NzAwa3VIOXpCMGxMN0FnTUIKQUFHamdnRWFNSUlCRmpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUE0R0ExVWREd0VCL3dRRUF3SUJCakFkQmdOVgpIUTRFRmdRVVFNSzlKNDdNTklNd29qUFgrMnl6OExRc2dNNHdId1lEVlIwakJCZ3dGb0FVT3BxRkJ4Qm5LTGJ2CjlyMEZRVzRnd1pUYUQ5NHdOQVlJS3dZQkJRVUhBUUVFS0RBbU1DUUdDQ3NHQVFVRkJ6QUJoaGhvZEhSd09pOHYKYjJOemNDNW5iMlJoWkdSNUxtTnZiUzh3TlFZRFZSMGZCQzR3TERBcW9DaWdKb1lrYUhSMGNEb3ZMMk55YkM1bgpiMlJoWkdSNUxtTnZiUzluWkhKdmIzUXRaekl1WTNKc01FWUdBMVVkSUFRL01EMHdPd1lFVlIwZ0FEQXpNREVHCkNDc0dBUVVGQndJQkZpVm9kSFJ3Y3pvdkwyTmxjblJ6TG1kdlpHRmtaSGt1WTI5dEwzSmxjRzl6YVhSdmNua3YKTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBSWZteVRFTWc0dUphcGtFdi9vVjlQQk85c1BweUlCc2xRajZaego5MWN4Rzc2ODVDL2IrTHJUVytDMDUrWjVZZzRNb3RkcVkzTXh0ZldvU0tRN0NDMmlYWkRYdEh3bFR4RldNTVMyClJKMTdMSjNsWHVidkRHR3F2K1FxRys2RW5yaURmY0ZEemtTbkUzQU5rUi8weUJPdGcyRFoySEtvY3lRZXRhd2kKRHNvWGlXSllSQnVyaVNVQkFBL054QnRpMjFHMDB3OVJLcHYwdkhQOGRzNDJwTTNaMkN6cXJwdjFLcktRMFUxMQpHSW8vaWtHUUkzMWJTLzZrQTFpYlJyTERZR0NEK0gxUVFjN0NvWkREdSs4Q0w5SVZWTzVFRmRrS3JxZUtNKzJ4CkxYWTJKdHdFNjUvM1lSOFYzSWR2N2thV0tLMmhKbjBLQ2FjdUJLT052UGk4QkRBQgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlFZlRDQ0EyV2dBd0lCQWdJREcrY1ZNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1HTXhDekFKQmdOVkJBWVRBbFZUCk1TRXdId1lEVlFRS0V4aFVhR1VnUjI4Z1JHRmtaSGtnUjNKdmRYQXNJRWx1WXk0eE1UQXZCZ05WQkFzVEtFZHYKSUVSaFpHUjVJRU5zWVhOeklESWdRMlZ5ZEdsbWFXTmhkR2x2YmlCQmRYUm9iM0pwZEhrd0hoY05NVFF3TVRBeApNRGN3TURBd1doY05NekV3TlRNd01EY3dNREF3V2pDQmd6RUxNQWtHQTFVRUJoTUNWVk14RURBT0JnTlZCQWdUCkIwRnlhWHB2Ym1FeEV6QVJCZ05WQkFjVENsTmpiM1IwYzJSaGJHVXhHakFZQmdOVkJBb1RFVWR2UkdGa1pIa3UKWTI5dExDQkpibU11TVRFd0x3WURWUVFERXloSGJ5QkVZV1JrZVNCU2IyOTBJRU5sY25ScFptbGpZWFJsSUVGMQpkR2h2Y21sMGVTQXRJRWN5TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF2M0ZpCkNQSDZXVFQzRzhrWW8vZUFTVmpwSW9NVHBzVWdRd0U3aFBIbWhVbWZKK3IyaEJ0T29MVGJjSmpITWdHeEJUNEgKVHU3MCtrOHZXVEFpNTZzWlZtdmlnQWY4OHhaMWdEbFJlK1g1TmJaMFRxbU5naFBrdGorcEE0UDZvcjZLRldwLwozZ3ZEdGhrVUJjcnF3NmdFbER0R2ZESU44d0JtSXNpTmFXMDJqQkVZdDlPeUhHQzBPUG9Dak03VDNVWUgzZ28rCjYxMTh5SHo3c0N0VHBKSmlhVkVsQldFYVJJR01MS2xEbGlQZnJEcUJtZzRweFJ5cDZWMGV0cDZlTUFvNXp2R0kKZ1B0TFhjd3k3SVZpUXlVMEFsWW5BWkcwTzNBcVAyNng2SnlJQVgyZjFQbmJVMjFnbmI4czUxaXJ1RjlHL003RQpHd004Q2V0Sk1WeHBSclBnUndJREFRQUJvNElCRnpDQ0FSTXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU9CZ05WCkhROEJBZjhFQkFNQ0FRWXdIUVlEVlIwT0JCWUVGRHFhaFFjUVp5aTI3L2E5QlVGdUlNR1UyZy9lTUI4R0ExVWQKSXdRWU1CYUFGTkxFc05LUjFFd1JjYk5oeXoyaC90Mm9hdFRqTURRR0NDc0dBUVVGQndFQkJDZ3dKakFrQmdncgpCZ0VGQlFjd0FZWVlhSFIwY0RvdkwyOWpjM0F1WjI5a1lXUmtlUzVqYjIwdk1ESUdBMVVkSHdRck1Da3dKNkFsCm9DT0dJV2gwZEhBNkx5OWpjbXd1WjI5a1lXUmtlUzVqYjIwdloyUnliMjkwTG1OeWJEQkdCZ05WSFNBRVB6QTkKTURzR0JGVWRJQUF3TXpBeEJnZ3JCZ0VGQlFjQ0FSWWxhSFIwY0hNNkx5OWpaWEowY3k1bmIyUmhaR1I1TG1OdgpiUzl5WlhCdmMybDBiM0o1THpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQVdRdFR2WktHRWFja2UrMWJNYzhkCkgyeHd4Ymh1dms2NzlyNlhVT0V3Zjdvb1hHS1V3dU4rTS9mN1FuYUYyNVVjakNKWWRRa01pR1ZuT1FvV0NjV2cKT0pla3hTT1RQN1FZcGdFR1JKSGpwMmtudEZvbGZ6cTNNczNkaFA4cU9Da3pwTjFuc29YK29ZZ2dIRkNKeU53cQo5a0lETjB6bWlOL1ZyeVR5c2NQZnpMWHM0SmxldDBsVUlEeVVHQXpISEZJWVNhUnQ0Yk5ZQzhuWTdObXVIREtPCktIQU40djZtRjU2RUQ3MVhjTE5hNlIrZ2hsTzc3M3ovYVF2Z1NNTzNrd3ZJQ2xURXJGMFVaemRzeXFVdk1RZzMKcW01dmpMeWI0bGRkSklHdmw1ZWNoSzFzckRkTVp2TmhrUkVnNUw0d24zcWtLUW13NFRSZlpIY1lRRkhmakRDbQpydz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBRENDQXVpZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRVUZBREJqTVFzd0NRWURWUVFHRXdKVlV6RWgKTUI4R0ExVUVDaE1ZVkdobElFZHZJRVJoWkdSNUlFZHliM1Z3TENCSmJtTXVNVEV3THdZRFZRUUxFeWhIYnlCRQpZV1JrZVNCRGJHRnpjeUF5SUVObGNuUnBabWxqWVhScGIyNGdRWFYwYUc5eWFYUjVNQjRYRFRBME1EWXlPVEUzCk1EWXlNRm9YRFRNME1EWXlPVEUzTURZeU1Gb3dZekVMTUFrR0ExVUVCaE1DVlZNeElUQWZCZ05WQkFvVEdGUm8KWlNCSGJ5QkVZV1JrZVNCSGNtOTFjQ3dnU1c1akxqRXhNQzhHQTFVRUN4TW9SMjhnUkdGa1pIa2dRMnhoYzNNZwpNaUJEWlhKMGFXWnBZMkYwYVc5dUlFRjFkR2h2Y21sMGVUQ0NBU0F3RFFZSktvWklodmNOQVFFQkJRQURnZ0VOCkFEQ0NBUWdDZ2dFQkFONmQxK3BYR0VtaFcrdlhYMGlHNnI3ZC8rVHZaeHowWldpelYzR2dYbmU3N1p0SjZYQ0EKUFZZWVl3aHYydkxNMEQ5L0FsUWlWQkRZc29IVXdIVTlTMy9IZDhNK2VLc2FBN1VnYXk5cUs3SEZpSDdFdXg2dwp3ZGhGSjIrcU4xajNoeWJYMkMzMnFSZTNIM0kyVHFZWFAyV1lrdHNxYmwyaS9vamdDOTUvNVkwVjRldkxPdFhpCkVxSVRMZGlPcjE4U1BhQUlCUWkyWEtWbE9BUkZtUjZqWUdCMHhVR2xjbUliWXNVZmIxOGFRcjRDVVdXb3JpTVkKYXZ4NEE2bE5mNEREK3F0YS9LRkFwTW9aRnY2eXlPOWVjdzN1ZDcyYTlubVl2TEVIWjZJVkRkMmdXTVpFZXdvKwpZaWhmdWtFSFUxalBFWDQ0ZE1YNC83VnBrSStFZE9xWEc2OENBUU9qZ2NBd2diMHdIUVlEVlIwT0JCWUVGTkxFCnNOS1IxRXdSY2JOaHl6MmgvdDJvYXRUak1JR05CZ05WSFNNRWdZVXdnWUtBRk5MRXNOS1IxRXdSY2JOaHl6MmgKL3Qyb2F0VGpvV2VrWlRCak1Rc3dDUVlEVlFRR0V3SlZVekVoTUI4R0ExVUVDaE1ZVkdobElFZHZJRVJoWkdSNQpJRWR5YjNWd0xDQkpibU11TVRFd0x3WURWUVFMRXloSGJ5QkVZV1JrZVNCRGJHRnpjeUF5SUVObGNuUnBabWxqCllYUnBiMjRnUVhWMGFHOXlhWFI1Z2dFQU1Bd0dBMVVkRXdRRk1BTUJBZjh3RFFZSktvWklodmNOQVFFRkJRQUQKZ2dFQkFESkw4N0xLUHBIOEVzYWhCNHlPZDZBekJoUmNrQjRZOXdpbVBRb1orWWVBRVc1cDVKWVhNUDgwa1dOeQpPTzdNSEFHakhaUW9wREgyZXNSVTEvYmxNVmdEb3N6T1l0dVVSWE8xdjBYSkpMWFZnZ0t0STNscGpiaTJUYzdQClRNb3pJK2djaUtxZGkwRnVGc2tnNVltZXpUdmFjUGQrbVNZZ0ZGUWxxMjV6aGVhYklaMEtiSUlPcVBqQ0RQb1EKSG15Vzc0Y054QTloaTYzdWd5dVYrSTZTaEhJNTZ5RHFnKzJEelpkdUNMenJUaWEyY3l2azAvWk0vaVp4NG1FUgpkRXIvVnhxSEQzVklMczlSYVJlZ0FoSmhsZFhSUUxJUVRPN0VyQkJEcHFXZUN0V1ZZcG9OejRpQ3hUSU01Q3VmClJlWU5ueWljc2JrcVdsZXROdyt2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'
EMBEDDED_BLADE_MASK='__CP_BLADE_MASK__'
EMBEDDED_CONFIG_DAT='TnU4dVJtd3BNMWVzbVZ3OMvv51fvXcumyv64XyYx1Qq2aGgVi0NprO2+4bygDkHLxP/ltCh3XB82XSIo+zoo/ob8kASjneyyeagyYYAy+qPXL/E1lPBWcCksJb/eMAikGFbmimhi+u987uWisOUWFYpX89Uwn978MqDAuV8RpfJkAQ0jhLPvNj2Mcn2JtcMM06AoUSju9UVti+3nLaTk/pWq1SJ/yIh4rVJJQLzlr1MyhPPkI/OI8/xL6ENE0Bss8L5uf3ZlAsk5RqNIM0EEm9xi/u0huDUZQJRrIoEm6bGaoiBA3JifLKY//OHr90OMZ2PCyFoTQM2/N9p3gzoAhTdCWGE2kdFuWtva+FAAchQrh5xcdi/AUQ4K6MvoG409lRg9o7z8VKaOsXsf17xTxJIBK7ZnX3w1c7VH4yEYQQGa3DWSuo5m5QdwTWSjA+vl75lrh6mC72FtP+pQhaBIuZnjmQswz5OPxn697tE7b7DhMskVK/5jqMUBJjriLYKX4ih8dlx7FspmMlF8QAPtXuTZJmwyieO+EW2nTOQPLARK/ZIMaBacFQePO9U0AJFnK3nN+JE2T++//rLIxUh4bkAgn0SXznckQfF8GcXsYsMPT90st3dPUegK92qDtHXa7OLXII1K8KcH05CtAz+qoMprZgOX8zTO6zOpCr4D/8nPkXGAmj6efopx8yVOzuQmKQcAklctON+NhX1TRAwDWHJKEQXwkaVMSlgWaQl57cAHKOhiLHvLfHVNHJ5dI8th764/gGQjQMXSFtpu4i93zHERtyrqaGXZstZF3/bdzxpqUofehCaa+nHuOvvRSGPwDUQh+sk98lXgkW/+1C7FhLPuOA+jJMooFJJ2cKK0jmA474g4nYKae0PKgEEh9fbK6kz8xGMfXMsTML45QCH/uGaEzud7tMNxyisEbjBeVzUW46aSO4W6du/EpVMN/qn/fi/0QBn8pRwMu0p0EWHnu32sXDppvy0Lp92jj7S491FdkJCSLTkAdsScZRmBVrb322GYAnsptZ+4WHOh3NWtbCRoCSNBTMmfcbm3shjCSpa76VIVRDcqrFXmsgLPzO2y0lwmZfIIOsER+BG3qwadfy2Z7WSMJ2vl6S0XXh63eqqkp7IECdB9vHngH+metYfgHWk0P98xv8isZdvLQ7mEXP764wcR4U3Hy56ETsCi+CSgQeo+I7ogGWlr91LBbOGQTF0P6F8fresz1Vn0IuZt370HE5oEVHj43Q6cJ2/IAWkxdBHuZMfbXVbSgnqeUTYBb7sf/y/TpcHHlGTruCCUOsZla7jwQwcz/ssZ4WZaE671n59iNhQZN0+s1bk1rDbINH7rraV8bj0X7aEzqo+ATiQbZPuqljetU3DZoWZ2m8JuR9YbLSRLLjUP/lmtF2HQ/AQtsl2ktob0zPfT/a3+7aK2UAonGo3bPLEVokG0011eG8G9mWnEanOSds0ddttF8Iz03zKN9RqhhTL/M0+S44dCDkN+osoL3uZ5WPX+ns298NjrekPJHwekveaML+QVtuKwMqlQqz0MbqUY0WMVq/TmBIbV/Khi6EG0DKlU3WuCSESogZh91B+4h5NqPExFM2vxaM36qvi0DHhGe2x9M2nA9bh/zGAcvrfJY7FazDPgcc56gReOQuS7UPFvj+OnonylAsKfe0rt4Y9ORdIDbEGKMJRFcgcIjCu/zpeYBeZjFDwduQo5mvi4XAuCR8kV/ylsbTzIUh85gEj/9olRL4j8sXIcPKjJs9XrowEeTgzA6cglZ5GvwYEil/ce1g6r97Wz8zh0bw9E+vFlyCEtBoHq7Z2/vuAK04Q1aKdyt7jIsv0xB0S8YyK5iq0hEDsTwjHuxsq3o5OAkazPO0AJ0iMP4LvyIvBerrpKlpm3xcvIGB7DWvHq5uUOgE4f2Nj6qw/1yAmwy6gntyCO4x2iRU5JilJmFSSGq/HGAnv+N9w7emcfYHpb4OqFz3S/Wd3vSlj0i2egNgQYhtDCyVM4F9jiImDXb60Ok6w2ODIgR28kbe6h+vbZQZpHQNaLSiGKa4dHdct2bmTtNRPNMzxQVSV9Uf/f3C7nk1Mng9LOz5p0g2JlRZf5LRSZwlnw10da4qHWsyF6m7px+pyUz9E+A5/2L/WkjBDUCI9rUTLzgVEiWnGSKt9i7P3+1dWvYq945CCeiKeQytIvaM7NpbHwDv9U2X6PnMKQuuGy9QZttrcMlNyJajW8Ab219d6ELDuJndN400vt/lyLogMN2hwJ5dBo2iPgP4hdiY89G7wTWaSnt4pCvZgiyM3m0LukV97Zp4K3ZEoIhp13d3bNT2Bvm99IEj97HdJo0PIQcjT7qEoAOUnTwhrWCLeaglMSe7Sq2PYSX3QGz4xeSfKe0157/hlO7eLvmt27dzmjiz4jth6LrzrmYlrIP2qQ1heFXFL1sa3gnY5sa5hZcPpOtqeYpX23bmB7j8EmmuejyEJSu/AWpVD6kD4M5l8Sj6spc7clAbwyPUV62z9US1Ex9AlNW5XSIytPwH8KEbolJxyOohKklCflOBC4yabqckL7OAxCbP7OqTlkDI5IKErjy+6HtN6QjfacSjwowJ+TOlM0xfeBadLIol//rGVBdppbIhs9lOWhJZUszmwgRa8HkRHPkBcEvIodKWYb9cvqUN68hFl8tM217oOkkh6TAc2F6pI+96oWyypJnEDCFpG/DDmGGqqGbX7+vBprDOHyPOka/G+7Nk3SIc8p3fP8yumOpmdX+dF2TLrnReshFKxLd88nwPfJbhNsiIIPoNBEJ2udoOddGz+bDXwyPndHRNVXWRZdaA2eBjIgzWcb8ZNXh0V/isx/MIs2j1DN+VyzQhKZtFSotEbpt8aKCMo/JIM3Z3Oa8UHOVB+UL4iQkYZfOCrpXOmWFxzpdkykDieRlclxKOjCxnEbeJCSKvfE7wAOmBvMz3ASXtAtKoSuKHVN9t2zSVvFC2x7QnNRibLCKUkBnNBrohNbFpibooq4vAm0yo7HZzhl8IRVvp7pglQ2cE+07o81+a1vMO5um0K+VofMawS9jntNJ0da9XeAXXrR4vQVqyE7zmOrThOIpXAos5kCO3TwEvDge8+vd3VZOXd6z3D4VKtkY5pZkzp12vvJJryzmW7MdIaH7LLNF8gHV4/5At5W18V+WH+6AuGRqsKTUKL81jiBE46OhqNE6GifejOjKI8Sev5bFZIintLIaBc1ZrEHmeC7ZRLtK8kOkqujmKDjiJxumQWP8N0IE1iIcfoZWjpdNS3iEFc/ESvP3AL/BCCUPfWDjL2HX6PRtptky5hUCjMoCOwAoQJYv6s6mRloIFE6aA2BLXyLBLOGLtUxIiKjwzcZlkdacrJ9LOzZw5kPCCZjsf5oVyrdYPcX+Pv+iEu4xo8adU+fcHbnHw8Xmk59u/fCAMpMUtWDJa/KLcbqhjzU5iFPNFty6lYjNaKHUnsuR2CW5PSLHBgkV+dIeU/W7Xbk+EgjL2GQTEcR8oogJGHqoMLK9zbTWvrVik28I36AMZsMz6bHiTm4iCyDFgvVc3YF5LwfKXk5a/+lMncsWLl13ca3zy0GGpL2kx1xhUGe9zSpFsw1DNNCwu7EupcVS3Ze2F6MtF/C2Vw0jUql3Ltt8VASwSrjH2VMzbQk4fqWVkahGDsm5skQN4QGiCxuCxskcx5dbsZlCVLNpgh2ob95iomSvOSDMZZLcC5CC1Z4BBAnMpBrpp9XEraQntjHYtrCPNqOOx94RmoaMtORLR2dLSTF2Pjr5vDpj+aFfpe0izlbAvyDwRhf7rRKyoEDaCnk6YnZv6hYBc0cy/tAm3WTYtwSvdypPEkfbmslH0FMk/NMgyxTLWTOtUXFtPabM7c2f5HsaFvDQ82A5EhP/0oUOyAFj8ztKJyiuZU8TESIOExs2VUiLPOFeP+D5R7cjqqsWfI+bG+KOWmqjYzhyQMF22OlxGyxaBqHBbl1O4mlsrb7UpFNUqKlU4wRY+d/7llCj6bWrcvuD/Beg116DrdtxrUXfx7/cWlkKFvHDtSe7ZjCylVDkhEtULojLSmiv2XyeAuFO48Tma2kVYwLwk+6JtxLNBdWMYAR+aklKPgiG31U+m1cvDqkOQFOeB4eAsj6mD5VC3Bhk6UJNQPp12rP65vsdrhFfspOHfaJBlJ+AxYzZofir+axoTiGG9sDuFGMq97c6Wsqlib/YwMnUjOln7/DVGO3q89BlQNanihaxnUEUz7ONo8/C8BiENrqcPtMLPHwkYuYtU9af4ujbI/R3kU+YuFsdppMBT4XQsdWbvquUPzL0XfXqfgBYHE6hu+LNtimU3++z8NMUNn6Ii0KzIf02SzxG7AEAJWhCKqWzZ4EnL3c7p42euSRiCh+eJ0vrtVZvO/0Re+CXiceijSIe8M6aIV89Dsyi+FiKFKPPpu0uZOwkWcTj6Qfg1YrEjsXpRq5+d7lZh6BRfAm+dR4No8y6vFmV/vJUkaF1slEbJ833MoWYFXKrOQldVBzYJU2/W1ANHaEOkrUzta5GXwSjxAN5gkWvFg8T6K2slnMZwvJmtB019eKp1/TnW68CWvnLisKtCJC3KtiQPqTpEfG1/Ifh1a1wx7fX0W6zYHZiuI2bUG64+s8dgN1hDpo1su4fmUl05LUKXj6SrDK29YxKyTTgF4uGPNY0YwyuX9R+xAJdDoJBt/0jFhaMQxFfhOyTBwPi5Nacko8PQ5U0KDskejH8qGMZhYi2bBSHOAJevdW4alf7qpKHIMPdYibyY4UfZsaFzXXgYAM/qPslrj8CyQue1RSPqCH2Ggq7uVBtLV3cpcrLvPS9y1cWaYyauq2v3ceja6tn2kUVdJmvac2Z43+DKc/rWItUntx4W6JOx/0doGR3QC3cVJDO525D16T6Cv9u3MoIj1W7s+dEhaqbujjSqZ+aOjrYO0sNPlCPGmH0qubNjwVUyXQRyQ44o6gn6XixWB45QNduWbCwcOFhcGOfj09xDRMkYR/Y99UliOrerIhQr5PP4H9vm8vDliLeAASlTFxSripraQBxrJQdVFbwLzN5S6SJyfY7Y7YVsoWx9a6PEgqDU+x3u0fSXwQCp5J43BPUb0fnhIGfzBCOiqxNlRgPOWeVsBja43RL8G5p95zNdqqnnkx2ekzfkxhsTbozGMQDB98Mct31FhwjICf//108MR61PJOt/SKxszBEYO0pe9Jr82NLdRQs1TdsInPtFjOdkBMCr7xOxKBHq9AgZ0m0JX8U/gCI82bVUKXRdy67M/X+eQIG2nMfqtq4PU5tRByqwjhbfQR4k7RM91Wr9nj4qCZIzNdpaEKAWkxYhPh7xzN9sxvONtq7m7QTYAD4l4Yeu1OGJPnPqCbZwMZ8YVSnQII1r2kmYAusOuOTvPXZQORUCwaLBBPFeVK4uhZTx6qTwjk+M8LxVkDhZwhtusF2bnZ7XzBCNcCtSYvtIm9OLsIXnRQ+GjEf1G+ZlKiNoSoVBkZvk7HLX1CRXs7DGixsnCldxQNAuO7PKtJGRgrWYsMnYK9e8+93kW9gTmaAGEwhXJDFsNdmO4Gr/nb5W5tuyOcgy+VZBL01rGCqFj5+9NyBqTvXOGbtZHkumSEeue8XIj6YIBqqJirM6AI+yCWF0KLACYzDn4PxEsEco6ntMqJyHizmHcl/EZ2pcwPlYAErPcpOw63ShxZ7tyyt6Kwl3IeZ5hehxw4CB+QOyIFBUHaE7GXqyq6AVmfF8TZBm8JxLkBURSbQ9qfc5MxPQjmX/bEP76HHqPAAaNBcGrQafR05KwCpBnwIfspRApQAax8+am0abuRxVu6r/jRwyVbUIp/vPDAh+HV+gA0Ae5B/u6BfftmQ/33Ti+sMjFc7PuxsaCASYnE5kx0IqiD94BdgVSJjn39OUgLWucvwDQX9PxNXvo9vgl/M/BADhe3GcS9SxGd3Nkdq7w0BXwrfDKH3Shnw7/JZpINqxt2h1sqIUgEgfyAz4GSy0onzKKoOtw93xJDnAHfwxwVvGmlmkYAPoKpGluU8ugOo3p1iDlf0NcwrIa+rM79AnUVhhpce1uepdJv0IZwuBakFCx1czPDnWwJgxn/I3JBxPhAsd4Yuw+fZJc+f/YREK1aJC36eY3rcSlkiTqFMcz4uzk7+5nGmT25eP9VWO76HI63d8rzBxfC3L9OSCjFkJ4GeLyycLyDnz1u1+hJoVuCBDrnJOGeM6pE3YrGgV0yWKgcx+7t629kNede2KFi7KvJqcO4H0UttVeyI4MXYyDDXQuVqlUDg1hDVB5kg5CwsfNhgV63IWOivW9PGWLGZLdWZaPHYAR1FZOqImNI3TWZbLRhOZOx0uMJNpug/fJTg3MwYVBDtuCy3B8A8I5vs5raxmIK6HxLOcZQRp40mPj9POS31N1uYwRd18r5l2w3LwpBsoRQz/+JBessvGpqQ68DLvzEKNKT3NHOdOrB73tN56JlN7cUeOKT65ZHgXfrd055NHEwMaIMqfVtR/o2IeWd4T0/JExkxhhxAm8AvCmKFUqcWtwT9XQ5vLqc3X4huO79nB9WPs2nYunmxQ/xdlcJRa4Ir9muEtD+0qqyjHpYYaJbFlhc1+6HF1eA3F4HYmrDRF2ecdzykglPWoU7HfDipUrJy7bFuZy7R8pQs2Re0m1rXkX7ZhcauFrXo4qUn2KTzEfneXptX45qwzZW8k4RfRiOnatBHAe4hdcrt+MsM6m2TesIbSjP/6emDJAhC8qdm2fkOHCKltatJQwmSIxqKyk4vYpll+0BYRykGRYCpfvTbhBykfDy9EnyWtfLIT/rEUPV8TYMqfsFaDtXHJXPsKF975GJtQVxERB04ouhrZ9qC/Rp13qaoV+xxS7jVSU6Wu9PHEfQlmJfDZ29/zzT+tetLOu/GpJpaLyypcn0c6NGhPdzZC01CklXkOXfw27oJP6aZCYFaYHk/xMqhMMhzMnD4YM2COj85Dhk08KCq7797VQHHYHKzXezCSRKUKelBfH+T/2B5SbcQxVigRlYuXMEV0A+vJ5MclqBiGEzoQ4t4KGnjXDTBqe0Xmi2I82pCoGLLmgOEuSHHwEORXujfKMlr2hnf3b6xJJmAMONvp8lJu+118ooAIrhMKNcAjzSRsqmMVn3UwlmZOtf48ctUxUddp1vibgnyHHjiyg4JSft0wlaJXQYFH5puilgOnUHqnwN40b2/FN11yQmzMqk7KICsACnM483xxls7HZ2t2raIIfJHXpVGQw1/pDXKEAUnttUFa4I87sQXoHbcXmfbDgK3DhANgi6S0SdUzrMSblkkDysrBtPtqz3KSJjOgiQtmLAPNi6MUakd5fFd3KBC13z+0L9+L3BiBhAVRzw8oEw1FBul2ptJwrO0aI98w6saTo5/REaL6LUYdty+tDCvt60Uj6f/inX0eEiKZbtP8edV8rZG+u+bvJ/ZEvP8gv/bJYppx5CtVZqivoRr5DImuFpowP15RBe2Qdy5z6qf9WiAdkVdI3zO2U9432wLr7233aF2TpSANbf+7kYfbq2FPrUSDYgjf9WNeFkS/PJoNRUwIqu+lAC10JTcCHT5bHu7rM0wDvwju+o/SHODQPbMWakV4i1P8TmZXUzNRNeU2jUH6SMw/LX2DfSOeTEj4AoW28wkfWYI/kcKrrG1xWH5gdJJ+Wv6CR6bnFMyHQ4Qmx1CdnhZ+/S/J8eW36isaKeeV5BUmyG+Z2RiUJfQENKqfvJyyr7ZVvCZOSL6ZFiYUN1fGbdp+c6FEt5GeLOe/R+2h5T7Vq5v+wtdKSrO/5sevUWiF1CB0GT+Cjpf8ZwY6ONhngTvSQagGk8wATLYTRQqSBS6SIP4VxOEfwwZ3NI5x8gcTJTWp1cK8/TAXl3BOmA592EnhlAunigvVH0btqUHTrfzsTjFdBQpl3JkeamhosvyhUPajM4hxaSuxrN+WKIDVH7suO/FnhrOaU7TtM9RH5rruB631XdfI8TFyck5pVhS2qONYGhNvBq24ZHzPeEq0KyjLeWVnwlfltQMw6p7ocppCHP8UN5KqxBB4XHmSy4orDNouZcPaBAY7ZnysenGRvDs1WvIScVh+9Vv91Pq9SCqGXRs1bt6+I+v1tb8GDJ+mzUBaNVcxDi6iCNH4NOt1WNai7QDVUxBYyeCro+xt3VEhQwWD9WLvZ3BQ9yq0xPbIKWb1bpxuyG4WpTBFLUEWiHmFpjilTdMfW4BlTRdTw7Hw/EG/4H946UDOBZavaVRLHsrcMA+38Lj67VUypny+YGUC/FfFHhQwZ7/FB4HW4XSU22AY6W0fLB2uA7NLFQ47Yl7l5Yx0E3wVhGTlKAt9d/h4ZvvN56JZDAveKssTtDyZyZsrAw6RL6Mq4t7nPJ/HN1kCLhOTv+ipmOw8mbOK/gIrvXw3ce9EwrctF3LzgzCEwQo/6+POx+uvK/Wo1sNbQKpmtVorM8Fihyew4bFbsznkPeikJK/erDRPL/BLfCuhuarL+iXQmZUGBnN5Qzqo0MD2+lbKGPHxiXvq8FBwXZi5Gr4xQWflZfXGGkt2VKDsDg+N8+EzY00dGLfPb10BhwfIcj9PpMjjw6H9Ur6AXjsDtKyi4pn13a0rCxJpgk4bQuJafg7RlJGZLf/LDfwmwyJv12p0JX+mDFZif42s4uGlhBbfvpc+dlnY+g0p6yI2UCc3ZB2VRgLI3o1TC70pRPAl2af6gXAtE2u5gVEZeOxbZm7JgjAEsn+h0anmaoSjfw7jmagXnJ+mF69TIERttaAb5MjaJOEeuGoi/7WqwACW5CprD5634PgojUYlK1xGtoQneqrwHe2hOECVtmg4GeF1v0xmROR/MobQcBpdR8c8Y1o1YamgTdxp+JhkIR0oS/Fvle7QMv25d2XSZNY/lU4R/78rcW6mbJk1hkavorouR4ZmfEzAVwMaBjz8HNj25+f4avlaFLfjio2OKLfpLBecE7ZFCdpCaQ7AUj/EGoQemCWXRGUm5bioU2PWEpFNuhYcmtDgYKJ06uIyx6FIDyts/EpWr6VqeBl1qQyYFomD5rj+H93nq0lANFsGJKtikhNrfAZWCW1DIT1hW/7K887SdaS+CXe19Bn2BglV5aCTi95RjLeAQgkXWa792umYogOrn/+nXj1TP4IqEoJZP2q6RaQIzKlpXBhpRyXDo7dOVbR/4PfCu3j0SaKt70VN3H1dzZlaF10TR/HUGxK/Dh9cizKv2ZPAUE+y8zDsCNKUE8rho8KG6SVq5HT9HE8SkQuLxEVirxZW6y0wxZeMS/vIHnB6cErWlt6FmhFnxm74EFVJSvALI0QzTi+aTeaTaw6c6SvzVpD25VrBA4/C3YjzhXzlmvSQeeWh9EMQ0ZXEV/mymCxwWD7uf/bHnrTRRBbR9fsSrBsZymEXrQBmNL7VpW39RYx9Ko3DZRbgXz4gf5MHfFtRocz63StWxC50jFCZUlHrfF+owCzrmdvinCskcrn/ePxPI8ZF+/byiDcdv3GAXtHrUA4Xew+YdrvmTyNJnml7Y49BKgDkXo9J9ki5Qgejz4Q41yMQ7ukrGkqyAMEtFSOGSkHMngqb1vMzX4nw2Cs+unhryfLEcd6v0gwDJ3PPM6zOrNr9gzGyVh8F7hCwcZxTkk7dupIqPonSuBmKnjpVkh9DZMCTcvKk7DItrKIjWx0dA0DUJFmdKHbl+ups3uXcjBxUdl0bIYjtCZJTdx08QqfVwWlQt2wxX2AGhtiZlwlb0fok1eDaeLU2Z+2yBebb5KVDTNL+bq5B3OThQ0iHWSOy7GlXx8mu5lYNma9ufykp9ia76Qc15b0rpK+g4jSDAGsDQx9H+ES9fADMdNcCFsIm4FBIosmyqX5gG1MjrePdGAN0KkhGkuw4eL/+LSvU1dgLw29Wzt6ouPWDjhWB76vCA5B1Iwi3Mk6Q/3Jqyt6T60VegsSztOFNM2SMQNz3pG10vXttTS9hag+a/6QcCLERAak2urPVHxh5xQaXw1ucgrjDLTKnn+3Sb2G6AgHL5UrSjoaKbWefG2o8goBlzwJ3cQsOL6/ZIJMZiIQAx4Uyu3sdc7Xn8xg+tG92jKbUijfVzfQMGlz5e9BtNpB+s9sQIw9Tlvh/OgMsBddrbtbUsnMACywK7zgkW11/7QgzoqyUJsYUqwo4Apa1TFLEiOEjqK7Ib7ZDZaqIrG+tje64CpVk89xyU5MfZTOokdj5cXCW8huXdQaqPxzSmgWSXPzQzb/Vjg77guhxczgypthHj9kfw0lxFifwNXga9KX6KNHjU8AjFsDG9YCSW7Tfo+txlHnGxsdosynm/USuEQQEdbIcgyqStA2l56Cy42GefbEOOEfdawJYgZWRbjwK57QMbuG370w5pPoZV8+Zd8vK/O766SB97vmtyHrlMHqtT9OQm6nrWfztALyl8/eb4ykCpHe6Suk+SvG/7eHP3UbwcsH3vU6bpjMimPZ1GsfxUcbhHWTvpNx5Rlb8pVCdWgaYqNHfZJQjdnCbvcaGuUNI0w+5SzeFW2rJzJZSQxgYVkH5LIwg9gvW2jIY6K6tVt3buRyPlmwz9V9DdtVD9mAccvdyeC/S9P5Tetopa8F8Bqxo7G0wAS2D+OvJO90veyMWG36yxT+lOk6s+et/lRqnGKuU8ln/UTRx6gtCtKxCtMMSsg3Ewcjmq4my660bsNIOJ0BtdZMIB/h/GVYu1N7CLlCt/uZz9RziKs/9WgeXThGONRfy1pXrRFF5iagmdpdE12xWhZhC1OgdhNYEmVc/r5otH0UqVKR1SP625S5BZn3BHa7Gfz8ke2TfwDOmA064T8pYV5dMKe9B1KEil3FZAvsXDSwmibUOb7eM3b0U/ExELLBz6QSQEgFojTJ0VoWWGbVtDaIJsZQ0+RRueDHyl4n+r68OhbmzMGFp2wJ5pi4ZjwMf/86vBhyMm/txOnEjGynpszB2NyWIz4rxs/+ptqpY1oKp4d5X08CdxhHkN14gH2XZU+lr7Ky+vHfGD/3qfYeWOOTKhCWgulZs3xqQSd/Wu5waOEczU3bZtyXI5cMriXSj+AReMNJxdhKJHqSrGSBfU2rg+yX9bQ9nPXh4lPidnB2Fiieeshr8YQbyvGg0x5JK4fAbdzQXDs9C3KSzUad82Q19duTAwb5Aj6Zlh3noOu+aFO/+avvTdpWqFFYEd1wGnm/yyTqCxEk5MkmrdoAYX/eULL6RkuJWn9uEBmlXDRV/Z7V/zQgazfQxN8jz703fVUk+I6cxEr3J0zS2lkME7v+twCjPfxuRsxdHia5U47g5imCORn9GSdr5GR0vA54GYrlROZjADiMn/UUZi+GXbWElRUkSlkTIhEkGuV7eT6FPtKaWCvPYzZCydvhztgGp4vFAXGbeBnBKb3PzynFCf05Sps1SDsCyPMDuLCDpi4w21jmrJTXdqIGinIvaViup6NRzeBLlJzhhz6/1HX8sIzrhs4zc6JEhgJUOEI2IRbPeWM3cn0YAUbtotkrl/mb/k4q+L4lupEjOeovp5mjG27lkc+VPNlK7jcwOm6JFQa4qgmljPQ2DChB46ga7QTHpe08WlOo38Gndn0e7e2S9fIEq9tV8egIF/U9AiTdH6JzxJnCOlsIjZODL558YrzIFWiF3dZnXeVULoS5AXUSYDS+i2iy4BcaklenveoduVwWWfX12q9+nkTEb6HVnO8gKi+BywaGHBm3bWdArSTSpiOFWzMJwGI3M6DXc+AWugYXPEgUoov5VL60y7w3d1jdrMJyTmkTj/9jW1b511GIvFpnA5rAEEG3QgDioVwOMtY52Jm8b46ivkUsGCuc2eRlDLNk9Y0zAfN5RXiqwGMzor1iVcE25LtiSfNo8KZ56E+WIs+Tk0OdD+58GYP6pQ7+i9dS8+gmxnIGgkkw91SSeO5hFwXlCdz72voIZWqNyWL6B5wobXjt5kbFUPHUPmuuMyrLgKC88jLL9bDlmDLGepRkET//eNVnq2XuW3gJhnnn4gvbufGqH3sAx7Wd0gfsc1lv50+kTp5vPq1gGAba04Qwr/2TyNVKKFB06KGwxcI7e+8W/6nH1NTbWQzxgMLWmKAR1THVtcW7pcCI+5918hS3UaET10Iu7WeylubOaobad7IVWaDdM/kxbagB2dSwB7npeQPr1Y2ihXzEZXvQ0ol2IsQGTfCOJOveVfAjBMJFmGAu1WGbs4/rhX6qiNRc/XckIUBrcNITB4eQHNBENWRmf8wp/bOUP2jH3kTZUfavVgaEH6m/rDc16sDwRZpr3OylNSExPK7kiwLU5+6wNLOjRzDuaqzo1LWyu3CcpsPZ/y5VRCUfbfht92ZJbja1z9hgJt9fyN0VxteI5T+BD1iM6AbcWDm/fj7EP2HjMdMt40FIBgUeC4hfV7AAlGGxgL00y31CS2aKbtB411HHx1QoaUD41F6tpY5dbrjh5tSl6/EpuD/k8OI5mM980Ylq+3kAQzm1kRfU5VgGb9xEvoTma63YlpacYi+bMfSHoc71kfPNcuFHG2dI4C3ekvkeHwn2RsGrNaQ51fPm8fQYhGrW9wCS4FTDqNl5uejGNTSqkQOfF1dwu4bpHq2ACgznTM8P6UP+fFf5ggfOL12AUp6gbIRjeS8ULdtQ+lCg0sg6mV/faIwBpRhcwlOloYOpPjEJpTGKtkjhadgjaq9xKENdXc4aLAwOKq8IIOCFgEOWXg+r25hweSwkufw2WUpJ63ilbwOQWdwSGoiH6xvGab0OjQlZNfbrWRg8H6DC80WSHMvRYlg9G09IYFjRafp4wzxpGzRGZNRj97cSUB/352CtJXoSTML9/oHMr05ANVKZpViwBKk/VI5DdlHGHSBGlfWo8atL+P8OFZ4UI/ggaTJgBK4S9AxQf7QaqxryO1EsPJVE2xuAQfzxm5XxA/TJDpuqeotW/0SxppuTQ/OMUHgo4BYuW+L1Oq2Obfc1GBjJ2OmOfHZWPEWI80Fht9/pTOn9Mr7sfAxQyFO4HHcOEc4sL6sGXDcxN7zlPNuxIsLXf0x3m+rmNzv5HDa/28PSux+4IDXtCHIhvgcjXZ5GaRplPhcrLhiU+BInhcdYLOp4WXubCjOiJ5imyO6/IkjA6GWwfxqRv+vLWGbz3PtSDJ0aFn0pWlJUxIKUAG7oq1mruUrRkNS34zNNVaXC8ip/qUbzyZPZ5TeEcdSx0Q+CVtdmQw6gfvFZoWSCkLwYD5zT+vA3NtckqKOqMetk26OLR2+OFodRZmz6nt96BprZdGtSnBw26gB5ELYjsgBCJ9q7+E+vIvDvb/85gJYFN5JPPUEQeP0/dfqdoXokQXV0irp/wT1qAUmbz+G4H7WRyW9FFnY0A0FdWTjX5Qx8dnMpJt4JOWYAfjDa7uVDGplf31ZVLudZ7msbdHLjLHjLANj99kFjBXwEhkjC77FYdUU1tMH7iws+WHSJ7wGTald2rnW6OxELIU4/zCY8/KSRVwNT3nhl2bVOwNNjll+cztXLjdA+ECKNXWP7t86E8DKjLQGrssEc5igol3aCL3QMMemdX9rNFgRo+XM0lxtpwztZvOLiZ049/wOF0JlY2ywHw3+9G5X1J22bP7swrttbqoYvj9MZkLVJXVRvhovQYMYl6AA2eODFgmS++bt5ElML0CgVppI2iNx0BOxsPR4fVxYzoWLts/00oYr0iif06/AbHw2h//F1f0EAQMl3kwVmg6QqiTcFspoPIio9KdQmklDfDzuLFiIcVe78WecAwDN0uTBWSxp8n7RZqP8Wurj3eRQu2hnJdM9fuPs8uAzdLoe7pAkE2CyNV5aGvZ4EKUMRL4frgRfzSB7caNQYoC/gY6g8nWENpM83D0MGHWdcUbcZ8O9u4VH5evaAiSP2vmosdEYxhDWUY2JOy4Um3TXOk4+P0RjkTGncm7nEEHVpGN/oEPVggeBnOb6NszuPmA5GAzj+uyMM79uoYEiSGrrb9iV7n+rBViK9rrtLUPsLFYSRDOeTV46KlmnuVXTzkyxzEisAB86NIEheqSD8iZrLuXCJjximULQq+9xs8ge6MmCchYnrTMbtWvFFWl80aWcnNutHcW6rzI8584apjj8n8Hkm6ejooqlL+6n42z+kIGBBIWZdfbBBIJxwQsRj0NYz67Z3tKvzDN4SCeDnfPlRb892xgm6RiIo81x3ZaxIvLyklb/VHgFHcDzQtK/SiYH0w9UNNZULfNagJPEXXiguzon5AIipHokuDRrbqjaPzTArBhioq4KpaSVfMsnZo3GrTzf/VzWq1FW80TmkjRX7xv47oZSHczyH40zbSTtdEzAFeeZF7JPeLNfZgaSE0MxJrOofaeMKrCflqtjHGOSVuYi+gMYHcXkaEgPSgqdVl3l3AH645MXZ0yo7S/QSFWPxqXTIBuPOu4n2LeWS6eqIQJPQtxnBfkGuMZh/n+QrtXhz/Vzxb+VlUUjhOOj2WYjFLkQnmIxJsejg4XJjk18fcezjjfLmjHhHs0LXc73BGBKatlvRTjhfUwOInD77ZVr06iTkDlykeV/Aw68JpCqopozmAHb/LloaNd1T0mllbdZ2V0Dl5nNhjoTmsp/AcuvJ2KCouJZn673RMj6L5KK+AFHMDoGFZg3MevYA3VgsRikcT2U/CSKCF0yZPk6lbLSj+MExnNJSQlt65ybcp8eM//5gH8ZLUT8WZha8Z7j1Kafw2s+L3hFXWKWMqlP4YHgcXkESXfcBK4Q2igcv9WBqhZSdZyR9N+Ok+4gPfY3s+GvEy5adf9XuhTxEMLF2l+ixIEF1YpmYBLRvdFtkcvTOdAg+EmY60Naw9WMAwznX0XV4P/l7LcV8+8V6DTPkBuSv+WUi+odoEOP6ekVw88ZLZ+21PgBuPFFxi48V3//bZJEvQQzK1L+R/vRUMJHT8CBUefJFGkfjM7PvMrQCqjwwNtD1gEVHv6uvnppS5lLRCp4CRdLQE5/C8HPGvOZJztN+RGpU+Eva09U0NsDisWpKOOfY5N9Yy+27lMNk4j1Qv67g6kEPZhOO2AUAdzeHLWya17763AjRrCY2tJ0tebdGn23gTeakJ7V8i3VCzTq86p5D0Y60rSMkIylTyuKN3azmD/tERcMsNcTXpdIx71+b7RYmXMCVaEhRgta6NJs6mLC3sLiDKCGFf8Ih3dB4CmgRDNB5t5ttggUtL0iq0GKK5D6nd2+poqineVCESA4iSwuxspjkcDIyJxiz4WoUfmEhid3/Darnn/4MT3w8GvG/vUWYHwkXLxs4l+Z5SWz7U8+xh2ZLRDPfoupOw1a1Wd74bor5Q7XTZ7H2QUV1tgAsLFDHa8YDGzFK/eQbEax5M8LujiySgcAfUqpF5Vf46ZjsANpyl+/zDzQd7Ty4lz5Na5K/EeHHfyHe4UeI5h2s1fMy3tImRUZGTybLW6Cwf+FZVGIO9EEYXbyjjLNTCnVPTWYgdWUMeCA1bRxOeO9z4Pqg1Aa8eZOYlMTENvnXVFV6hbrAz6pK1RUvv6dezsxKM3CP4JKgZC1XpYSjf0SdcEA+lxA/gVG68ZbCyc6DevowRWfj00lyZGGp8Y3qbjh2eIXjlhZMpEruSYsu5+7Xs9Yl5FefLHWh0XCbvLX16Kgh85kvyGon3HeP/RAHhbhXNxlVdWtSrrwZGKwVrvoAPBJRwxWyGFXrdiL3X6dYFLw8IvlFu4j/ZU7JHNLNsjg9HV6T7eKPVTQ0lRWlXZLap8tkTIiFxOF3ANGpc9mxdSesvIJWlEgoMRlkhsRRNSUFH8bnG+LdgcZCqYwwmWS6t6NvQIMaRD88fhHwI1aRdEe+CFGdVtu7jg2ta9hIEkoCo7p9XLHmK5vEmguH/SSJADtytGhqYrMTSFMiR+zrL8/BxFp1+Q/aP+39Y56gwGwLEqF7axu1GvMwffjLkESJgipmy9mABhGF7+2nC46OsX3JMbOps6TLQIyA89m8pJS3zgdBuhpa2gHIwIeHHXwhSGJ6Zjbk/H+DrfMyVi0ziEQx/WEVasUtDQvH0WRIyajP+KCYcXPIc+/Zq+Rm8SQzh6RXeTLgX3DY3mGbY+/6Oza0GxEyJaQ9wtfh9M/3Q4X+U68ZhAQ9r4btd0q4xAoubghvwheu+hIRx08s9vOTB3neTa8y7a7OmpZgf1LaOdt7g4TD5wDkuB1BwlYjksIBXtbZjrT7r89xsfZl0TodK+As4ZD/TuR26hIMUpfe+5mnbq2e/ogyLwTSjWg0ukXsELOrbGSgYktN2IvJbOO6bqkGDlQlmCeuUHxFf/HyoKt6tJIM/k9J8MpSD5TaQTHiQkx0+fE1oxlKaZROGek9mGQhdRTCG7nz2NCFYMJiYciWWjIuRD4/jKQ57hvf3HdRizUCb2709OrEDvhZAl2yL2vQDOdd2oVRx8Yw1wwHan/Ak99Sckth6ICUfFEEgqNcyM3Nw41hwo12yKJLarsdXOBgF8B0L2pwpocF6l8U2aIgYJctSX0ys1Vzhv26YbOTGcvcfv7xy3NniVL3djCyZQez7xIRCQGZdvrybOT7wQH3w7DP5oyBuKuG0C7hX0QVgo7WrUKW5TDy0CdXmhMGfxgo+uXBueSZ2Iq9oCuUbXUS67rELD9vR4vGbwpmuHgo2WJ5Ip5ZzVR+2QR6CjWKo2fpGWOzQHRQ+TbPwX8cZ8Pqbmp5vUMTHXgBGQ1PrZ4FqUsDjlBirqaF5gACZBDa9QVC2SkzR+YwTrbnWLXUbNgZUwCXROYwEWWwEtDaqc9xiqjjDQnPSvFmLAbUKyP+j5Cok+2HppvpBGBjmlP/RcIg3mnfGv73yX//9hlXjAcekc9ZFiSHDOod9KrjqID/32DWvkGR/pmo/aTT0Puu25asjpAyx9VDhb5K8LJ2uORZGkml4YH9jOYpTChc+wAjXUD2mC6w5cYq8vaR00DbM3pdCqSN+wc+dipihA8qNMkjyIK7q2EjrU+EY/Rm1zCDRU4r5RnPCh48O3+B3fFC0bri00+t+W7H9Xen7lNRhg0blaEzT4jWiXP0EipfZRmf770VFex8Yvm2hW5UeG8c62LptaC8rxiZpYKWm4UWJKJFDvKOKWiLgMIwSXJRfTgEUVn0LFZs0jO/JlOfGRvqBA+65HVuGSNmdmYWtRMHS/gsOI0GD4NJlC7/d46pj+T2OQKFzn4eavmE6rFcf9dI1o+a3tBgt/dAprKm7Un2Udqg6bHLBJendaZ32YuvaA99CHoMoL7FW8+J6HdTxK5Jc91xvGdtccZvtCUODALgkzDgoH8j1pfpHFkdpANKahqhdSoWPKn7pacLdZo8y6elgDhK8tda9dr3WWIJvVRNwy7KuyQUAc38dQn6tBSprosWhx5kLhpq5aDrt7LT6ilMZ190lCwoe8+gnEfRndw/QVJGWST+ETtV5W9IMaOPJRxd0QjkHRLs7wQOON555QoC/xBIJBOcsSOAAmfkniclO2trLfqBOGr7OXbxgDpKZNbkukrsMkbxPVRaNYe4OA/kgzpwaxiayb/mgRRE4g3OOY5aZUnuPFG0bQc3d8VzKYoIbpXHiNhW7VdmcJvRyh77uBmabd6IpR8oOKju2JQgfZ+noVkbaXOa1mzd5II2RrlNQ+QsxvOF9nN1QZ0CnS0g+rmVz5wbhPkaDiA9rbZ/x4sl5r86fFUmvcKE8YIugjYK1ktUkiJf81IEv0XB+bCHyqGOMOVBgYFKlSXY5Trh5MeEz9QCgFzo4vMYGgI0nJe+mPeQbYPTTtWlOwtq6MSQFcHYBgELgCt+TsP7tzpI7mOenFGtVJmkDAa543eBpAi+RhdKvCg7q6mDobRlv3yEBIBH2dvMbPL6PQilr5dmXPvDU93z9+6zQfLlZyxD0AFr518nB8wnEsAkb/f2BdxGvyRzjVt8MaP750HOiqt1XQZR7YmrQE4pQS1NYIOi9zaZ25dUXNyC/Ij0toi07Vq9oOYMcAlnW8IOO6GDx/Z0NQjHW/McUswhlsHkGE5oI5UPjHnBbrroVIWaF77cIK2IhWIhT2t4FwmC6XOP9JRQAu1XcFhgFas8cDea7NINLLYD6JkfZlv7M9TGuTzIIgSCd9WJ6uRhn562ghFUag80FH50rNX6Tmphp3erW/bseE0PZ++HpmzYhrcgqICd63u6Obd7RqTv04VbjEk28fvUhunxs5tmAEVlKPwhOWguo+OswyBfaObxqzxjxnzjGDs+xVLR9LCHqoSeQ/RQRgsJX9oW0tsLASaKtqI1WeIsOWxLY7XkLtFDKNVnXKmcy9GXLTu/4b1WOZcw0SmkkouMIR3PQnaKZyBuFgan0ouRkb26d2nxYZUsBRsSa9LKo14DR9eSwawIl7amECqtLYDguwtryB0ZWwUJ6FeCv8xInrM20M4AYxuNw0ZaJRnXh+nD+w+JONBHXNEyDfUytI7p8NQD3yuflQtDhA4M96Zks85AVouu5u3/5JXnEy3NFskKBoexhYGVnjELXmBDsvEYKOXBwUIxzWZWAFFLRs9n4LKAOQmogSWphlCdiizqISq/lVb03r1JWEgMCqxv69JI+W46fz0q+t/XvpcwDAm60LRp2XqfnuOb+iU5WPm3wljNdsp5Ozoaq8dRzBurUAi3Ax98iyM4WzsV9Fa4GrypOzqL9kPMsIQOZ0uCsw1xjYzUrhOVzMMrcxtsAY2jiAoOQ3m7idqphQYhY5iR0UyZ22X3zyNnpiT812BLXx4s3bYUyk1rNP4b7pXnJlimnkoEkS6KKuymln487PHIUJDvu5cIqtBPYbIBtpj38biFtqFqmdsxPdNKGr63myycH9BquxFDP21g6DIKhWoKkiwlXv1KMHXysTWsviaU03ebsLtyTyIwxdH4B2/AmVZNooff/eKRObLkDN+MMA4MIxPTHCgEY61QipS40BOqM6X2csmM7996DofDLB0amEOPCoQMdLj3gEBMnMKFfq8LIPJ9OnoF8VEZSUl0E8VwcpioX1SO9KRAVjCgKvemjrS5SXOPRDZCtL/mSBk1gbzjTbOlw+3CN9Be+e11Nu0wvAzqW5sHuGrv1BJnDwxFbG+qhZlpy9hSVMEcObbya2RmQdCAi3veRnmEH8WyMCCmoRSmKwiJ9DAR+c+be5WoQEnHOPf+fMuRDQs0rx0nWxFqCdjcP9FLFKDi5xvq9+7Kz+SVzn3iWaOTulSKB+7bi/SXk7w7It5Mh1CsoYNolz8e7DRTK2hI0mNq4PGHTIwjEYlaFjUvguvuokF8qWTXP1N5ilEt63SyaE7ywZH4FRcxr1sjnQAil0RhUnTCbXh5vu6KHlc3ZLftBTVQ9fKDQT/a7AXZlIYxhZ841u9gB3qaa2kKIQub2W7eOy6XkUpW+ScDB6nwEkTrOcrItvmx3PxrTzrT8oYM/Ujc/DTGqoXtab+KMDBOWVaogLYgMyjsGz3n9Cb6v5ns+a6WHJGwrKZ783mGoJLx4u3/hj5gX1QKSH/xEYDwcqIKATtDDdfaFDsPXIt/77jJnAtivAfsqcHaYI59QMFG/fJ8YfwR0sHpKNUHCvwe5uOxmJFYTI8IX1zfPkdWv23Kevy9Cz9EhdAlJQ7LmrgaPaOrsD6Tfd1qFhVcg1hqYF10l1alYeiMsETNzWwOEOrfZ3EE2QDOu0FtX4we5RVdhEypzT/r+/3RqN/82/EQZB0uwLfsvSQb2Wcm/sXOtxYaKaIUkTTCAh9tyAQ38eG8ygk99UwcgX2PJgjzuISBMRWkJy+TZNQsbqYYuKyGU4zFW5Rer/Szz4asWHcslo1gUCZ5XhDuOfIYuEc5WHzF8tVmtAmDS+kPuJnHx8GCiOTC8dutqTGTE3ynucfTSxpg49oCEhk3lnMw7sozip7MACNFMeoGUvgU7sTpafwwFJgqEFb8FOoQmxrp3MDrslP59heSQW8h5KZzy9EHEZ7HoGui7QIBY1eXSnYqedw6Mmm9jr0QQgrgI8FMBHPY3gFRbeB3EYvuAJQbET0hPoPTovQnTEiCC2jg2JPj08OhvLT75CB0vhfsIufp6l2oReA/fPN6YxXGkUPhIfF'
EMBEDDED_DEFAULT_POLICY='__CP_DEFAULT_POLICY__'
# <<REPLACE END

ARCH=$(uname -m)

# function to check if embedded argument contains a non-placeholder value
function is_valid_embedded_arg() {
  local ext_arg=$1
  [[ ! $1 =~ ^__CP.*__$ ]]
}

function is_suse() {
  [[ $g_distro_name == "leap" || $g_distro_name == "sles" ]]
}

# apply valid embedded arguments
function apply_embedded_arguments() {
  if is_valid_embedded_arg "$EMBEDDED_MGMT_FQDN"; then SBA_MANAGEMENT_URL="https://${EMBEDDED_MGMT_FQDN}"; fi
  if is_valid_embedded_arg "$EMBEDDED_MGMT_KEY"; then SBA_MANAGEMENT_KEY=$EMBEDDED_MGMT_KEY; fi
  if is_valid_embedded_arg "$EMBEDDED_MGMT_CA_CERT"; then g_mgmt_ca_cert_data_base64=$EMBEDDED_MGMT_CA_CERT; fi
  if is_valid_embedded_arg "$EMBEDDED_MGMT_CA_CERT_SIG"; then g_mgmt_ca_cert_sig_data_base64=$EMBEDDED_MGMT_CA_CERT_SIG; fi
  if is_valid_embedded_arg "$EMBEDDED_BLADE_MASK"; then set_install_products_from_blade_mask $EMBEDDED_BLADE_MASK; fi
  if is_valid_embedded_arg "$EMBEDDED_CONFIG_DAT"; then g_da_config_dat_content=$EMBEDDED_CONFIG_DAT; SBA_CONFIG_DAT_FILE=$g_da_config_dat_file; fi
}

# write log rotate file for a given log
function logrotate_log_file() {
  local logrotate_base_path=$1
  local logrotate_file_path=$2
  local log_path=$3

  if [[ -d $logrotate_base_path ]]; then
    echo "${log_path} {" >$logrotate_file_path
    echo "  size 10M" >>$logrotate_file_path
    echo "  rotate 5" >>$logrotate_file_path
    echo "}" >>$logrotate_file_path
  fi
}

# write environment file to be used by timer jobs and possibly product services
function write_env_file() {
  mkdir -p $g_save_folder
  : >$g_env_file
  set +u
  echo "DEBIAN_FRONTEND=noninteractive" >>$g_env_file
  echo "SBA_REPO_TYPE=$SBA_REPO_TYPE" >>$g_env_file
  echo "PATH=$PATH" >>$g_env_file
  echo "HTTP_PROXY=$HTTP_PROXY" >>$g_env_file
  echo "http_proxy=$http_proxy" >>$g_env_file
  echo "HTTPS_PROXY=$HTTPS_PROXY" >>$g_env_file
  echo "https_proxy=$https_proxy" >>$g_env_file
  echo "NO_PROXY=$NO_PROXY" >>$g_env_file
  echo "no_proxy=$no_proxy" >>$g_env_file
  echo "SBA_USE_MODERN_BPF_PROBE=$SBA_USE_MODERN_BPF_PROBE" >> $g_env_file
  echo "SBA_SEMI_ISOLATED_ENV=$SBA_SEMI_ISOLATED_ENV" >> $g_env_file
  set -u
}

# update a single variable in the environment file
function update_env_file() {
  local key=$1
  local value=$2
  if [[ $2 == "none" ]]; then
    value=""
  fi
  if [[ -f /etc/checkpoint/cpla/env ]]; then
    sed -i "s|^\($key=\).*|\1$value|i" /etc/checkpoint/cpla/env
  fi
}

# remove environment file if no products are installed
function remove_env_file() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    rm -f $g_env_file
    set +e
    rm -df $g_save_folder
    set -e
  fi
}

# manually clean the garbage
function remove_leftovers() {
  # clamav traces
  rm -rfv "/etc/clam.d"
  rm -rfv "/usr/share/clamav"

  # install/update timers
  rm -f "$g_systemd_install_unit_path"
  rm -f "$g_systemd_install_timer_path"
  rm -f "$g_systemd_update_unit_path"
  rm -f "$g_systemd_update_timer_path"
  rm -f "$g_systemd_product_update_timer_path"
  rm -f "$g_systemd_product_update_unit_path"
  rm -f "$g_legacy_update_cron_file_path"


  # configuration
  rm -rf "/etc/checkpoint/common"

  local explicit_files=(
    "/var/cache/checkpoint/cpmgmt/logcache.cache"
    "/var/lib/checkpoint/cpmgmt/telemetry_msgs_sent.json"
    "/var/lib/checkpoint/da/config.dat"
    "/var/cache/checkpoint/cpsba/bg/linux_rules_version"
    "/var/lib/checkpoint/cpam/cpam-status.json"
    "/var/lib/checkpoint/cpam/infections.json"
    "/var/lib/checkpoint/cpam/status.json"
    "/var/lib/checkpoint/cpam/te.yar"
    "/var/lib/checkpoint/cpam/mitre_db.yaml"
    "/var/lib/checkpoint/cpam/sophos"  # dir with am signatures
    "/var/lib/checkpoint/cpam/scan_ipc"
    "${g_install_log_file}"
    "${g_update_log_file}"
    "${g_switch_repo_log_file}"
    "${g_ar_injected_flag}"
    "${g_efr_injected_flag}"
  )

  for f in "${explicit_files[@]}" ; do
    rm -rf "$f" && echo "$f removed"
  done

  local explicit_dirs=(
    "/var/cache/checkpoint/cpsba/bg"
    "/var/cache/checkpoint/cpsba"
    "/var/cache/checkpoint/cpmgmt"
    "/var/cache/checkpoint"
    "/var/lib/checkpoint/cpam"
    "/var/lib/checkpoint/cpmgmt"
    "/var/lib/checkpoint/da"
    "/var/lib/checkpoint"
    "/var/log/checkpoint/cpam"
    "/var/log/checkpoint/common"
    "/var/log/checkpoint"
    "/etc/checkpoint"
  )
  for d in "${explicit_dirs[@]}" ; do
    rmdir "$d" && echo "Empty $d dir is removed"
  done
}

function setup_sophos() {
  local cpam_dir="/var/lib/checkpoint/cpam"
  rm -rf "$cpam_dir"
  mkdir -pv "$cpam_dir"
  mv "$g_bootstrap_dir/sophos" "$cpam_dir"
}

# offline_package: extract self contained archive from install_offline.sh to mktemp
function unpack_bootstrap() {
  echo "unpack_bootstrap started for $0"
  if ! grep -m 1 "^__ARCHIVE_FOLLOWS__" "$0" ; then
    echo "Error: this offline package does not seem to have embedded archive"
    echo "Please ensure, that you're using correct package (install_offline.sh)"
    exit 1
  fi
  awk 'f; /^__ARCHIVE_FOLLOWS__/{f=1}' "$0" | base64 -d | tar -C "$g_bootstrap_dir" -xz
  echo "unpack_bootstrap finished"
  echo "ls $g_bootstrap_dir"
  ls -la "$g_bootstrap_dir"
}

function prepare_offline_package() {
  g_bootstrap_dir="$(mktemp -d)"
  unpack_bootstrap
  mkdir -p "$g_offline_repo_path"
  cp -Rafv "$g_bootstrap_dir/$g_package_type/"* "$g_offline_repo_path"
}

function ensure_bootstrap_dir_removed() {
  [ -n "$g_bootstrap_dir" ] && echo "g_bootstrap_dir: $g_bootstrap_dir"
  if [ -n "$SBA_OFFLINE_PACKAGE" ] && [ -d "$g_bootstrap_dir" ] ; then
    echo "cleaning temp offline_package dir"
    rm -rf "$g_bootstrap_dir"
  fi
}

function ensure_upgrade_conf_dir_removed() {
  [ -n "$g_upgrade_conf_dir" ] && echo "g_upgrade_conf_dir: $g_upgrade_conf_dir"
  if [ -d "$g_upgrade_conf_dir" ] ; then
    echo "cleaning temp upgrade config dir"
    rm -rf "$g_upgrade_conf_dir"
  fi
}

function create_systemd_timer() {
  local systemd_name="${1}"
  local exec_command="${2}"
  local systemd_timing="${3}"

  local systemd_unit_name="${systemd_name}.service"
  local systemd_unit_path="/etc/systemd/system/${systemd_unit_name}"
  local systemd_timer_name="${systemd_name}.timer"
  local systemd_timer_path="/etc/systemd/system/${systemd_timer_name}"

  #  -- Start unit file
  : >$systemd_unit_path
  printf "[Unit]\n" >>$systemd_unit_path
  printf "Description=${systemd_unit_name}\n" >>$systemd_unit_path
  printf "Wants=${systemd_timer_name}\n\n" >>$systemd_unit_path
  printf "[Service]\n" >>$systemd_unit_path
  printf "Type=oneshot\n" >>$systemd_unit_path
  printf "ExecStart=${exec_command}\n" >>$systemd_unit_path
  # -- End unit file

  # -- Start timer file
  : >$systemd_timer_path  
  printf "[Unit]\n" >>$systemd_timer_path
  printf "Description=${systemd_timer_name}\n\n" >>$systemd_timer_path
  printf "[Timer]\n" >>$systemd_timer_path
  printf "Unit=${systemd_unit_name}\n" >>$systemd_timer_path
  printf "OnCalendar=${systemd_timing}\n\n" >>$systemd_timer_path
  printf "[Install]\n" >>$systemd_timer_path
  printf "WantedBy=timers.target\n" >>$systemd_timer_path
  # -- End timer file
}

function start_systemd_timer() {
  local systemd_name="$1"
  systemctl enable "${systemd_name}.timer" || true
  systemctl start "${systemd_name}.timer" || true
}

function remove_systemd_timer() {
  local systemd_name="$1"
  local systemd_unit_path="/etc/systemd/system/${systemd_name}.service"
  local systemd_timer_path="/etc/systemd/system/${systemd_name}.timer"

  systemctl disable "${systemd_name}.timer" || true
  systemctl stop "${systemd_name}.timer" || true
}

function schedule_install_systemd_timer() {
  if [[ $g_install_with_systemd_timer == "no" || -f $g_systemd_install_timer_path ]]; then
    return
  fi

  save_self

  local logrotate_base_path="/etc/logrotate.d"
  local logrotate_file_path="${logrotate_base_path}/sbalinux-install"
  local log_path="${g_install_log_file}"

  local systemd_timer_install_script="$g_save_folder/install_systemd_timer.sh"

  local env_vars_exports="set -o allexport; source $g_env_file; set +o allexport"
  local echo_log_cmd="echo \"--- starting install: \$(date) ---\""
  local last_install_command="${g_saved_script} ${g_args}"

  mkdir -p "$g_log_base_path"

  : >$systemd_timer_install_script
  chmod 744 $systemd_timer_install_script
  echo '#!/bin/bash' >>$systemd_timer_install_script
  echo $env_vars_exports >>$systemd_timer_install_script
  echo $echo_log_cmd >>$systemd_timer_install_script
  echo $last_install_command >>$systemd_timer_install_script

  create_systemd_timer "$g_systemd_install_job_name" "${systemd_timer_install_script}" "$g_systemd_install_timing"
  start_systemd_timer "$g_systemd_install_job_name"

  logrotate_log_file "$logrotate_base_path" "$logrotate_file_path" "$log_path"
}

# remove install retry systemd timer job, should be called after installation success
function remove_install_systemd_job() {
  local logrotate_base_path="/etc/logrotate.d"
  local logrotate_file_path="${logrotate_base_path}/sbalinux-install"
  local systemd_timer_install_script="$g_save_folder/install_systemd_timer.sh"

  remove_systemd_timer "${g_systemd_product_update_name}"

  if [[ $g_install_with_systemd_timer == "no" ]]; then
    return
  fi

  # clean-up any additional systemd timer related things
  remove_self

  remove_systemd_timer "${g_systemd_install_job_name}"

  rm -f $g_cron_file_switch_repo_path
  rm -f $logrotate_file_path
  set +e
  rm -df $g_save_folder
  set -e
}

function is_http_url() {
  if [[ $1 =~ ^http(s{0,1}):\/\/.*$ ]]; then
    echo "true"
  fi
}

function is_guid() {
  if [[ $1 =~ ^[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}$ ]]; then
    echo "true"
  fi
}

function is_sysdig_needed() {
  local blades
  if [ "$g_operation" == "install" ]; then
    blades="$g_remote_install_products"
  elif [ "$g_operation" == "update" ]; then
    blades="$g_update_product"
  fi

  [[ "$blades" = *"bg"* || "$blades" = *"edr"* || "$blades" = *"efr"* ]]
}

function is_ge_ubuntu_22() {
  [[ ($g_distro_name == "ubuntu" && $g_distro_version -ge 22) ]]
}

function is_ge_debian_11() {
  [[ ($g_distro_name == "debian" && $g_distro_version -ge 11) ]]
}

function should_use_modern_gpg() {
  # Modern GPG key handling required for Ubuntu 22+ and Debian 11+
  is_ge_ubuntu_22 || is_ge_debian_11
}

function add_gpg_key() {
  local key_url="$1"
  local key_name="$2"
  
  if should_use_modern_gpg; then
    local key_file="/etc/apt/trusted.gpg.d/${key_name}.gpg"
    echo "Adding GPG key using modern method: $key_name"
    mkdir -p "$(dirname "$key_file")"
    curl -s "$key_url" | gpg --dearmor --yes -o "$key_file"
    chmod 644 "$key_file"
  else
    echo "Adding GPG key using legacy method"
    curl -s "$key_url" | apt-key add -
  fi
}

function add_gpg_key_from_file() {
  local key_file_path="$1"
  local key_name="$2"
  
  if should_use_modern_gpg; then
    local target_file="/etc/apt/trusted.gpg.d/${key_name}.gpg"
    echo "Adding GPG key from file using modern method: $key_name"
    mkdir -p "$(dirname "$target_file")"
    gpg --dearmor --yes -o "$target_file" < "$key_file_path"
    chmod 644 "$target_file"
  else
    echo "Adding GPG key from file using legacy method"
    apt-key add - < "$key_file_path"
  fi
}

function check_offline_package() {
  if grep -q -m 1 "^__ARCHIVE_FOLLOWS__" "$0" ; then
    export SBA_OFFLINE_PACKAGE=yes
  fi
}

function check_install_cmd_args() {
  if [[ -z $SBA_MANAGEMENT_URL ]]; then
    echo "Missing management server configuration, for usage run: $0 --help"
    exit 1
  fi

  # accept base64 encoded key
  if [[ ! $SBA_MANAGEMENT_KEY =~ ^[A-Za-z0-9+/=]*$ ]]; then
    echo "Illegal management server key"
    exit 1
  fi

  # Validation of URL is not strict. The possible one to cover domain name and IPv4 address is:
  # ^https?:\/\/(((?!-)[A-Za-z0-9-]{1,63}(?<!-)\.)+[A-Za-z]{2,6}|([0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]+)?)$
  if [[ ! $SBA_MANAGEMENT_URL =~ ^https?:\/\/ ]]; then
    echo "Illegal management server url $SBA_MANAGEMENT_URL. It should be in form http(s)://<IP|hostname>"
    exit 1
  fi

  if [[ ! -z $HTTP_PROXY && -z $(is_http_url $HTTP_PROXY) ]]; then
    echo "Illegal http proxy url"
    exit 1
  fi

  if [[ ! -z $HTTPS_PROXY && -z $(is_http_url $HTTPS_PROXY) ]]; then
    echo "Illegal https proxy url"
    exit 1
  fi

  if [[ -z $g_install_source ]]; then
    echo "Missing install source, for usage run: $0 --help"
    exit 1
  fi

  if [[ $g_install_source == "remote" ]]; then
    if [[ -z $g_remote_install_products ]]; then
      echo "Please specify product to install from the remote package repository"
      exit 1
    fi
    if [[ ! -z $g_local_install_file_name ]]; then
      echo "Package file name cannot be specified when installing from remote package repository"
      exit 1
    fi
  elif [[ $g_install_source == "local" ]]; then
    if [[ -z $g_local_install_file_name ]]; then
      echo "Please specify package file name to install"
      exit 1
    fi
  fi

  if [[ ! -z $g_version_to_install ]]; then
    if [[ $g_install_source != "remote" ]]; then
      echo "Version to install can only be specified for installation from a remote repository"
      exit 1
    fi
    if [[ ! $g_version_to_install =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      echo "Version to install is invalid"
      exit 1
    fi
  fi

  if [[ ! -z $g_install_with_systemd_timer ]]; then
    if [[ $g_install_with_systemd_timer != "yes" && $g_install_with_systemd_timer != "no" ]]; then
      echo "Invalid argument for 'retry' option, please specify 'yes' or 'no'"
      exit 1
    fi
  fi

  if [[ ! -z $g_should_schedule_upgrade ]]; then
    if [[ $g_should_schedule_upgrade != "yes" && $g_should_schedule_upgrade != "no" ]]; then
      echo "Invalid argument for 'upgrade' option, please specify 'yes' or 'no'"
      exit 1
    fi
  fi

  if [[ ! -z $SBA_VDS_LOCATION_GUID && -z $(is_guid $SBA_VDS_LOCATION_GUID) ]]; then
    echo "Illegal group id. Group id should be in GUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    exit 1
  fi
}

function check_umask() {
  local um
  um=$(umask)
  local supported_umask="0022"
  if [[ $(umask) != "0022" ]] ; then
    echo "Error!"
    echo "Installation script has detected an umask: \"${um}\"."
    echo "Only ${supported_umask} is supported. Other variants might lead to"
    echo "unpredictable behavior when working as an unprivileged"
    echo "user. Refused to proceed."
    exit 1
  fi
}

function force_env_vars() {
  if [ "$g_distro_name" == "debian" ] && [ "$g_distro_version" -eq 11 ]; then
    export USE_CPCLAM=false
  fi
}

function to_lower() {
  echo "$1" | tr "[:upper:]" "[:lower:]"
}

function ensure_forced_distro(){
  OLD_IFS=$IFS
  IFS='_'
  read -ra distro <<< "$SBA_FORCE_DISTRO"
  g_distro_name=$(to_lower "${distro[0]}")
  g_distro_version=${distro[1]}
  echo "Forced to use $g_distro_name $g_distro_version distribution"
  IFS=$OLD_IFS
}

function detect_package_type() {
  # check architecture
  if [[ ! $ARCH == "x86_64" && ! $ARCH == "aarch64" ]]; then
    return
  fi

  if [[ ! -z ${SBA_FORCE_DISTRO:=""} ]]; then
    ensure_forced_distro
  else
    # check distro
    if [[ -f "/etc/debian_version" ]]; then  # debian-based distros
      if [[ ! $ARCH == "x86_64" ]]; then
        return
      fi

      if [[ -f "/etc/lsb-release" ]]; then
        . "/etc/lsb-release"
        g_distro_name=$(echo "$DISTRIB_ID" | tr '[:upper:]' '[:lower:]')
        g_distro_version=${DISTRIB_RELEASE%%.*}
      else
        g_distro_name="debian"
        g_distro_version=$(cut -d'.' -f1 "/etc/debian_version")
      fi
    elif [ -f "/etc/system-release-cpe" ]; then  # centos-based distros
      g_distro_name=$(cut -d':' -f3 "/etc/system-release-cpe")
      g_distro_version=$(cut -d':' -f5 "/etc/system-release-cpe" | cut -d'.' -f1 | sed 's/[^0-9]*//g')
      if [[ $g_distro_name == "o" ]]; then
        g_distro_name=$(cut -d':' -f4 "/etc/system-release-cpe")
        g_distro_version=$(cut -d':' -f6 "/etc/system-release-cpe")
      elif [[ $g_distro_name == "euler" ]]; then
        g_distro_version=$(cut -d':' -f5 "/etc/system-release-cpe" | sed 's/[^0-9]*//g')
      elif [[ $g_distro_name == "fedoraproject" ]]; then
        g_distro_name=$(cut -d':' -f4 "/etc/system-release-cpe")
      fi
    elif [ -f /etc/os-release ] ; then  # suse-based distros
      g_distro_name=$(grep -Po '(?<=^CPE_NAME=).*(?=)' "/etc/os-release" | cut -d ':' -f 4)
      g_distro_version="$(grep -Po '(?<=VERSION_ID=").*(?=")' "/etc/os-release" | tr -dc '0-9')"
    fi
  fi

  # debian-based distros
  if [[ ($g_distro_name == "ubuntu" && $g_distro_version -ge 16 && $g_distro_version -le 24) \
     || ($g_distro_name == "debian" && $g_distro_version -ge 9  && $g_distro_version -le 13) \
     || ($g_distro_name == "linuxmint" && $g_distro_version -ge 21  && $g_distro_version -le 22) ]]; then
    g_package_type="deb"
  fi

  # centos-based distros
  if [[ ($g_distro_name == "centos" && $g_distro_version -ge 7 && $g_distro_version -le 9) \
     || ($g_distro_name == "redhat" && $g_distro_version -ge 7 && $g_distro_version -le 10) \
     || ($g_distro_name == "oracle" && $g_distro_version -ge 7 && $g_distro_version -le 10) \
     || ($g_distro_name == "rocky" && ($g_distro_version -eq 8 || $g_distro_version -eq 9 || $g_distro_version -eq 10)) \
     || ($g_distro_name == "amazon" && ($g_distro_version -eq 2 || $g_distro_version -eq 2023)) \
     || ($g_distro_name == "euler" && ($g_distro_version -eq 205 || $g_distro_version -eq 208 \
                                    || $g_distro_version -eq 209 || $g_distro_version -eq 2010)) \
     || ($g_distro_name == "almalinux" && $g_distro_version -ge 8 && $g_distro_version -le 10) \
     || ($g_distro_name == "fedora" && ($g_distro_version -ge 34 && $g_distro_version -le 42)) \
     ]]; then
      g_package_type="rpm"
      g_rpm_repo_config_file="/etc/yum.repos.d/sbalinux.repo"
  fi

  # suse-based distros
  if [[ ($g_distro_name == "leap" && ($g_distro_version -eq 423 || $g_distro_version -eq 153 \
                                   || $g_distro_version -eq 154 || $g_distro_version -eq 155 \
                                   || $g_distro_version -eq 156 || $g_distro_version -eq 160)) \
    || ($g_distro_name == "sles" && ($g_distro_version -eq 125 || $g_distro_version -eq 152 \
                                   || $g_distro_version -eq 153 || $g_distro_version -eq 156)) ]]; then

      g_package_type="rpm"
      g_rpm_repo_config_file="/etc/zypp/repos.d/sbalinux.repo"
  fi
}

function set_repo_type() {
  g_repo_type=${SBA_REPO_TYPE:=$g_repo_type}
}

function set_blades_from_products() {
  local products_str=$1

  # split into array with unique elements
  g_blades=($(echo $products_str | tr "," "\n" | sort -u | tr "\n" " "))

  if [[ ${#g_blades[@]} -eq 0 ]]; then
      if [[ $ARCH == "x86_64" ]]; then
        g_blades=("edr" "am" "ar" "efr")
      else
        g_blades=("am" "ar")
      fi
  fi

  for product in ${g_blades[*]}; do
    if [[ -z ${g_prod_to_blade[$product]:=""} ]]; then
      echo "invalid product '$product'"
      exit 1
    fi
  done
}

function bypass_proxy() {
  if [ $# -eq 0 ]; then
    # No argument supplied. no_proxy remains unchanged
    return
  fi

  local fqdn=$1
  if [[ -z ${no_proxy:=""} ]]; then
    export no_proxy=$fqdn
  else
    export no_proxy="$no_proxy,$fqdn"
  fi
  if [[ -z ${NO_PROXY:=""} ]]; then
    export NO_PROXY=$fqdn
  else
    export NO_PROXY="$NO_PROXY,$fqdn"
  fi
}

function configure_deb_offline_repo() {
  echo "Importing sbalinux key..."
  add_gpg_key_from_file "$g_bootstrap_dir/pks/public" "sbalinux-offline"

  # configure /etc/apt/sources.list.d/sbalinux_offline
  local config_file=$g_deb_repo_config_file
  local repo_name=sbalinux_offline
  # For offline packages, always use trusted=yes since they may not have Release files
  echo "deb [trusted=yes] file://$g_offline_repo_path ./" >$config_file
}

# configure sbalinux deb repo
function configure_deb_repo() {
  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    configure_deb_offline_repo
    return
  fi
  local repo_type=$1
  local config_file=$g_deb_repo_config_file
  local key_name

  if [[ $repo_type == "prod" || $repo_type == "stg" ]]; then
    local repo_fqdn=$g_secureupdates_fqdn
    local key_url="https://${repo_fqdn}/sbalinux/sbalinux-gpg-key.public"
    local repo_url="https://${repo_fqdn}/sbalinux/packages/deb"
    key_name="sbalinux-${repo_type}"
  elif [[ $repo_type == "dev"  ]]; then
    local repo_fqdn=$g_artifactory_fqdn
    local key_url="https://${repo_fqdn}/artifactory/api/gpg/key/public"
    local repo_url="https://${repo_fqdn}/artifactory/SBA_DEB"
    key_name="sbalinux-dev"
    # add proxy bypass for artifactory
    bypass_proxy ${repo_fqdn}
  else
    echo "invalid repository type: $repo_type"
    exit 1
  fi

  mkdir -p "$(dirname "$config_file")"
  add_gpg_key "$key_url" "$key_name"
  
  if should_use_modern_gpg; then
    echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/${key_name}.gpg] ${repo_url} ${repo_type} ${g_universal_repo}" >$config_file
  else
    echo "deb [arch=amd64] ${repo_url} ${repo_type} ${g_universal_repo}" >$config_file
  fi
}

function configure_rpm_offline_repo() {
  echo "Importing sbalinux key..."
  rpm --import "$g_bootstrap_dir/pks/sbalinux-gpg-key.asc"

  local config_file=$g_rpm_repo_config_file
  local repo_name=sbalinux_offline
  {
    echo "[${repo_name}]"
    echo "name=${repo_name}"
    echo "baseurl=file://$g_offline_repo_path"
    echo "enabled=1"
    echo "gpgcheck=1"
    echo "sslverify=1"
    echo "priority=5"
  } > "$config_file"
}

# configure sbalinux rpm repo
function configure_rpm_repo() {
  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    configure_rpm_offline_repo
    return
  fi
  local repo_type=$1
  local config_file=$g_rpm_repo_config_file
  local repo_name="sbalinux_${repo_type}"
  # Leave pure sbalinux only for prod
  [[ $repo_type == "prod" ]] && repo_name="sbalinux"
  if [[ $repo_type == "prod" || $repo_type == "stg" ]]; then
    local repo_fqdn=$g_secureupdates_fqdn
    local repo_url="https://${repo_fqdn}/sbalinux/packages/rpm"
    local key_url="https://${repo_fqdn}/sbalinux/sbalinux-gpg-key.asc"
    local gpgcheck=1
    local sslverify=1
    local disable_proxy=0
  elif [[ $repo_type == "dev" ]]; then
    local repo_fqdn=$g_artifactory_fqdn
    local repo_url="https://${repo_fqdn}/artifactory/SBA_RPM"
    local key_url="https://${repo_fqdn}/artifactory/SBA_GEN/repo_public_keys/rpm/sbalinux-gpg-key.asc"
    local gpgcheck=0
    local sslverify=0
    local disable_proxy=1
    # add proxy bypass for artifactory
    bypass_proxy $repo_fqdn
  else
    echo "invalid repository type: $repo_type"
    exit 1
  fi

  rpm --import $key_url
  echo "[${repo_name}]" >$config_file
  echo "name=${repo_name}" >>$config_file
  echo "baseurl=${repo_url}/${repo_type}/${g_universal_repo}" >>$config_file
  echo "enabled=1" >>$config_file
  echo "gpgcheck=${gpgcheck}" >>$config_file
  echo "sslverify=${sslverify}" >>$config_file

  # pin repo priority becuase we want some dependencies to be hosted on our own repo
  # NOTE: to make repo priority work in centos/redhat older than 8 we need to install the yum-priorities plugin!
  echo "priority=1" >>$config_file

  if [[ $disable_proxy -gt 0 ]]; then
    echo "proxy=_none_" >>$config_file
  fi

  # refresh zypper for gpg key auto trust
  if is_suse ; then
    zypper --gpg-auto-import-keys refresh
  fi
  
  if ! is_suse ; then
    yum clean all  --disablerepo="*"  --enablerepo="sbalinux*"
  fi
}

function remove_deb_repo() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    rm -f $g_deb_repo_config_file
  fi
}

function remove_rpm_repo() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    rm -f $g_rpm_repo_config_file
  fi
}

function install_kernel_headers() {
  local kernel_version
  kernel_version=$(uname -r)

  if [[ $g_package_type == "deb" ]]; then
    apt-get install -y "linux-headers-$kernel_version"
    return
  fi

  if is_suse ; then
    zypper in -y "kernel-default-devel=$(echo "$kernel_version" | sed "s/-default//")"
    if (($? > 0)); then
      zypper --no-refresh in -y "kernel-default-devel=$(echo "$kernel_version" | sed "s/-default//")"
    fi
    return
  fi

  if [[ $g_package_type == "rpm" ]]; then
      local rpm_pkg_name
      if [[ $kernel_version == *uek* ]]; then
        rpm_pkg_name="kernel-uek-devel-$kernel_version"
      else
        rpm_pkg_name="kernel-devel-$kernel_version"
      fi
      
      if rpm -q "$rpm_pkg_name" > /dev/null; then
        echo "install_kernel_headers: kernel headers already installed"
        return
      fi
      echo "install_kernel_headers: kernel headers not installed, attempting to install"
      yum -q -y install "$rpm_pkg_name" || kernel_warning
  fi
}

function install_prereq_offline() {
    setup_sophos

    if is_sysdig_needed ; then
      install_kernel_headers || true
    fi
}

function install_prereq_apt() {
  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    install_prereq_offline
    return
  fi

  # preconfigure samba-common to prevent it from popping a dialog requiring user input
  echo "samba-common samba-common/dhcp boolean false" | debconf-set-selections

  # common
  apt-get update
  apt-get install -y curl gnupg apt-transport-https

  if is_ge_ubuntu_22 ; then
    apt-get install -y glibc-tools
  fi

  if is_sysdig_needed; then
    install_kernel_headers || kernel_warning
  fi
}

function install_prereq_zypper() {
  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    install_prereq_offline
    return
  fi

  if is_sysdig_needed; then
    install_kernel_headers || kernel_warning
  fi
}

function install_prereq_yum() {
  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    install_prereq_offline
    return
  fi

  if is_sysdig_needed && [[ $ARCH == "x86_64" && ($g_distro_name != "euler") ]]; then
    install_kernel_headers || kernel_warning
  fi
}

function kernel_warning() {
  echo "Unable to find kernel development files for the current kernel version $(uname -r)"
  echo "This usually means that your system is not up-to-date or you installed a custom kernel version."
  echo "Please install up-to-date kernel or reboot system to load different installed one"
  exit 2
}

function get_deb_install_candidate() {
  local pkg_name=$1
  local result=$(apt-cache policy $pkg_name | grep 'Candidate:' | sed -r 's/^\s+Candidate:\s+//')
  echo $result
}

function install_deb_pkg_from_file() {
  BASEDIR=$(dirname "$0")
  local pkg_file=$BASEDIR/$1

  apt-get update
  apt-get install -y $pkg_file
}

function install_rpm_pkg_from_file() {
  local pkg_file=$1
  BASEDIR=$(dirname "$0")
  if ! is_suse ; then
    yum install -y $BASEDIR/$pkg_file
  else
    zypper -n in $BASEDIR/$pkg_file
  fi
}

function get_deb_version_to_install() {
  local pkg_name=$1
  local version
  if [[ -z $g_version_to_install ]]; then
    version=$(get_deb_install_candidate "$pkg_name")
  else
    version=$g_version_to_install
  fi
  echo "$version"
}

function install_deb_pkg_from_repo() {
  apt-get update
  local pkg_name=${g_pkg_name}
  local version=$(get_deb_version_to_install "$pkg_name")
  apt-get install -y $pkg_name=$version
}

function install_rpm_pkg_from_repo() {
  if [[ -z $g_version_to_install ]]; then
    if ! is_suse ; then
      yum install -y ${g_pkg_name}
    else
      zypper -n --gpg-auto-import-keys in ${g_pkg_name}
    fi
  else
    local pkg_name=${g_pkg_name}-${g_version_to_install}
    if ! is_suse ; then
      yum install -y "$pkg_name"
    else
      zypper -n in -f "$pkg_name"
    fi
  fi
}

function uninstall_deb_pkg() {
  local pkg_to_remove
  if is_deb_pkg_installed "$g_old_pkg_name"; then
    pkg_to_remove="$g_old_pkg_name"
  else
    pkg_to_remove="$g_pkg_name"
  fi

  apt-get purge --autoremove -y ${pkg_to_remove}
}

function uninstall_rpm_pkg() {
  local pkg_to_remove
  if is_rpm_pkg_installed "$g_old_pkg_name"; then
    pkg_to_remove="$g_old_pkg_name"
  else
    pkg_to_remove="$g_pkg_name"
  fi

  if ! is_suse ; then
    yum remove -y "$pkg_to_remove"
  else
    zypper -n rm "$pkg_to_remove"
  fi
}

function find_installed_products() {
  g_installed_products=()

  local pkg=${g_pkg_name}
  if [[ $g_package_type == "deb" ]]; then
    if is_deb_pkg_installed "$pkg"; then
      g_installed_products+=("la")
    fi
  elif [[ $g_package_type == "rpm" ]]; then
    if is_rpm_pkg_installed "$pkg"; then
      g_installed_products+=("la")
    fi
  fi
}

function get_script_update_url() {
  if [[ $g_repo_type == "dev" ]]; then
    echo "https://${g_artifactory_fqdn}/artifactory/SBA_GEN/dev/scripts/install.update"
  elif [[ $g_repo_type == "stg" ]]; then
    echo "https://${g_secureupdates_fqdn}/sbalinux/packages/generic/stg/scripts/install.template"
  elif [[ $g_repo_type == "prod" ]]; then
    echo "https://${g_secureupdates_fqdn}/sbalinux/scripts/install.update"
  fi
}


# schedule or remove systemd timer for product version update
# this function will schedule or remove the update timer based on installed products
function schedule_or_remove_update_systemd_timer() {
  # remove legacy cron job to avoid simultaneous run with timer
  rm -f $g_legacy_update_cron_file_path
  
  if [[ $g_should_schedule_upgrade == "no" ]]; then
    return
  fi

  local log_path="${g_update_log_file}"
  local logrotate_base_path="/etc/logrotate.d"
  local logrotate_file_path="${logrotate_base_path}/sbalinux-update"
  local systemd_timer_update_script="$g_save_folder/update_timer_script.sh"

  find_installed_products

  if ((${#g_installed_products[@]} > 0)); then
    save_self
    mkdir -p "$g_log_base_path"
    local script_update_url=$(get_script_update_url)

    [[ -z $script_update_url ]] && echo "invalid script update url, cannot setup update timer" && exit 1
    local script_update_tmp_file="/tmp/sbalinux-install-update.tmp"

    local lock_cmd='[ "${SBA_FLOCKER}" != "$0" ] && exec env SBA_FLOCKER="$0" flock -E 254 -en "/tmp/sbalinux-update-job.lock" "$0" "$@" || :'
    local env_vars_exports="set -o allexport; source $g_env_file; set +o allexport"
    local echo_log_cmd="echo \"--- starting update: \$(date) ---\""

    echo "schedule update timer"
    if [[ $g_package_type == "deb" ]]; then
      local script_update_cmd="apt-get update; apt-get install -y ${g_installer_package_name}"
    elif is_suse ; then
      local script_update_cmd="zypper -n in ${g_installer_package_name}"
    elif [[ $g_package_type == "rpm" ]]; then
      local script_update_cmd="yum install -y ${g_installer_package_name}"
    fi
    echo "after schedule update timer"
    local satellite=""
    if [[ -n "$g_force_no_sbalinux_repo" ]] ; then
      satellite="--satellite yes"
    fi

    local product_update_cmd="${g_saved_script} update $satellite"
    if [[ "$g_got_remote_install_product_arg" == 1 ]] ; then
      product_update_cmd+=" --product $g_remote_install_products"
    elif [[ ! -z "$g_update_product" && "$g_update_product" != "$g_default_blades_set" ]] ; then
      product_update_cmd+=" --product $g_update_product"
    fi

    : >$systemd_timer_update_script
    chmod 744 $systemd_timer_update_script
    echo '#!/bin/bash' >>$systemd_timer_update_script
    echo $lock_cmd >>$systemd_timer_update_script
    echo $env_vars_exports >>$systemd_timer_update_script
    echo $echo_log_cmd >>$systemd_timer_update_script
    echo $script_update_cmd >>$systemd_timer_update_script
    echo $product_update_cmd >>$systemd_timer_update_script

    create_systemd_timer "${g_systemd_update_job_name}" "/bin/bash -c '${systemd_timer_update_script} | tee -a ${log_path} 2>&1'" "$g_systemd_update_timing"
    start_systemd_timer "${g_systemd_update_job_name}"

    logrotate_log_file "$logrotate_base_path" "$logrotate_file_path" "$log_path"

  else
    # remove installer package
    set +e
    if [[ $g_package_type == "deb" ]]; then
      apt-get purge -y ${g_installer_package_name}
    elif is_suse ; then
      zypper -n rm ${g_installer_package_name}
    elif [[ $g_package_type == "rpm" ]]; then
      yum remove -y ${g_installer_package_name}
    fi
    set -e

    # clean-up any additional timer related files
    [ "$g_switching_repo" -eq 0 ] && remove_self

    remove_systemd_timer "${g_systemd_update_job_name}"  
    remove_systemd_timer "${g_systemd_product_update_name}"

    rm -f $logrotate_file_path
    rm -f $g_cron_file_switch_repo_path
    set +e
    rm -df $g_save_folder
    set -e
  fi
}

# save copy of this script for invokation from timer jobs
function save_self() {
  mkdir -p $g_save_folder
  if [[ "$0" != "$g_saved_script" ]]; then
    cp -f "$0" $g_saved_script
    chmod 744 $g_saved_script
  fi
}

# remove the saved copy of this script
function remove_self() {
  if [[ -f $g_saved_script ]]; then
    rm -f $g_saved_script
  fi
}

# for install operation: if bg is specified in g_blades then efr should be implicitly added
function enable_bg_coupled_blades() {
  local bg_found=false
  local efr_found=false

  for blade in "${g_blades[@]}"; do
    case "$blade" in
      "bg")
        bg_found=true
        ;;
      "efr")
        efr_found=true
        ;;
      *)
        ;;
    esac
  done

  if $bg_found && ! $efr_found; then
    g_blades+=("efr")
  fi
}

function do_remote_install() {
  set_repo_type
  set_blades_from_products $g_remote_install_products
  enable_bg_coupled_blades
  write_env_file
  schedule_install_systemd_timer $g_args
  store_config_dat_file
  write_ca_cert_and_sig
  if [[ $g_package_type == "deb" ]]; then
    install_prereq_apt
    [[ -z "$g_force_no_sbalinux_repo" ]] && configure_deb_repo $g_repo_type
    install_deb_pkg_from_repo
  elif [[ $g_package_type == "rpm" ]]; then
    if ! is_suse ; then
      install_prereq_yum
    else
      install_prereq_zypper
    fi
    [[ -z "$g_force_no_sbalinux_repo" ]] && configure_rpm_repo $g_repo_type
    install_rpm_pkg_from_repo
  fi

  remove_install_systemd_job
  if [ ! -n "$SBA_OFFLINE_PACKAGE" ] ; then
    schedule_or_remove_update_systemd_timer
  fi
}

function do_file_install() {
  pkg_file=$g_local_install_file_name
  if [[ -f $pkg_file ]]; then
    set_repo_type
    set_blades_from_products $g_remote_install_products
    enable_bg_coupled_blades
    write_env_file
    schedule_install_systemd_timer $g_args
    store_config_dat_file
    write_ca_cert_and_sig
    if [[ $g_package_type == "deb" ]]; then
      install_prereq_apt
      [[ -z "$g_force_no_sbalinux_repo" ]] && configure_deb_repo $g_repo_type
      install_deb_pkg_from_file $pkg_file
    elif [[ $g_package_type == "rpm" ]]; then
      if ! is_suse ; then
        install_prereq_yum
      else
        install_prereq_zypper
      fi
      [[ -z "$g_force_no_sbalinux_repo" ]] && configure_rpm_repo $g_repo_type
      install_rpm_pkg_from_file $pkg_file
    fi
    remove_install_systemd_job
  else
    echo "cannot find package file ${pkg_file}"
    exit 1
  fi
}

function ensure_offline_repo_dir_removed() {
  if [ -d "$g_offline_repo_path" ]; then
    echo "removing offline repo dir: $g_offline_repo_path"
    rm -rf "$g_offline_repo_path"
  fi
}

function do_uninstall() {
  set_blades_from_products "$g_uninstall_product"

  echo "deleting all blades dependencies of Linux Agent"
  set +e
  stop_service "cpla"
  
  # Backup DA storage if switching repo
  if [ "$g_switching_repo" -eq 1 ]; then
    backup_da_storage
  fi
  
  if [ "$g_switching_repo" -eq 0 ]; then
    $g_cpla_path uninstall_all
  else
    $g_cpla_path uninstall_all --skip-notification
  fi
  set -e

  if [[ $g_package_type == "deb" ]]; then
    uninstall_deb_pkg
    [[ -z "$g_force_no_sbalinux_repo" ]] && remove_deb_repo
  elif [[ $g_package_type == "rpm" ]]; then
    uninstall_rpm_pkg
    [[ -z "$g_force_no_sbalinux_repo" ]] && remove_rpm_repo
  fi

  ensure_offline_repo_dir_removed

  schedule_or_remove_update_systemd_timer

  if [ "$g_switching_repo" -eq 0 ]; then
    remove_ca_cert_and_sig
    remove_env_file
    remove_leftovers
    remove_da_storage_path
  fi
}

function check_config_cmd_args() {
  if [[ $num_of_config_args == 0 ]]; then
    echo "Please enter at least one argument to config"
    exit 1
  fi

  # accept base64 encoded key
  if [[ ! $SBA_MANAGEMENT_KEY =~ ^[A-Za-z0-9+/=]*$ ]]; then
    echo "Illegal management server key"
    exit 1
  fi

  if [[ ! -z $SBA_MANAGEMENT_URL && ! $SBA_MANAGEMENT_URL =~ ^https?:\/\/ ]]; then
    echo "Illegal management server url $SBA_MANAGEMENT_URL"
    exit 1
  fi

  if [[ ! -z $HTTP_PROXY && -z $(is_http_url $HTTP_PROXY) && ! $HTTP_PROXY == "none" ]]; then
    echo "Illegal http proxy url"
    exit 1
  fi

  if [[ ! -z $HTTPS_PROXY && -z $(is_http_url $HTTPS_PROXY) && ! $HTTPS_PROXY == "none" ]]; then
    echo "Illegal https proxy url"
    exit 1
  fi
}

# perform config operation
function do_config() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    echo "There is no installed product to config"
    exit 1
  fi

  local product="la"
  echo "Updating configuration for '$product':"

  if [[ ! -z $SBA_MANAGEMENT_KEY ]]; then
    update_env_file "SBA_MANAGEMENT_KEY" "$SBA_MANAGEMENT_KEY"
    echo "Updated management server key"
  fi

  if [[ ! -z $SBA_MANAGEMENT_URL ]]; then
    update_env_file "SBA_MANAGEMENT_URL" "$SBA_MANAGEMENT_URL"
    echo "Updated management server url"
  fi

  if [[ ! -z $SBA_ENABLE_BG ]]; then
    update_env_file "SBA_ENABLE_BG" "$SBA_ENABLE_BG"
    echo "Updated BG status"
  fi

  if [[ ! -z $SBA_CONFIG_DAT_FILE ]]; then
    update_env_file "SBA_CONFIG_DAT_FILE" "$SBA_CONFIG_DAT_FILE"
    echo "Updated config.dat file path"
  fi

  if [[ ! -z $HTTP_PROXY ]]; then
    update_env_file "HTTP_PROXY" "$HTTP_PROXY"
    update_env_file "http_proxy" "$HTTP_PROXY"
    echo "Updated http proxy"
  fi

  if [[ ! -z $HTTPS_PROXY ]]; then
    update_env_file "HTTPS_PROXY" "$HTTPS_PROXY"
    update_env_file "https_proxy" "$HTTPS_PROXY"
    echo "Updated https proxy"
  fi

  if [[ ! -z $NO_PROXY ]]; then
    update_env_file "NO_PROXY" "$NO_PROXY"
    update_env_file "no_proxy" "$NO_PROXY"
    echo "Updated proxy bypass list"
  fi

  if [[ ! -z $SBA_AUTH_PRINCIPAL ]]; then
    update_env_file "SBA_AUTH_PRINCIPAL" "$SBA_AUTH_PRINCIPAL"
    echo "Updated management authentication principal"
  fi

  if [[ ! -z $SBA_USE_DA ]]; then
    update_env_file "SBA_USE_DA" "$SBA_USE_DA"
    echo "Updated DA setting"
  fi

  if [[ ! -z $SBA_VDS_LOCATION_GUID ]]; then
    update_env_file "SBA_VDS_LOCATION_GUID" "$SBA_VDS_LOCATION_GUID"
    echo "Updated VDS id"
  fi

  if [[ ! -z $USE_CPCLAM ]]; then
    update_env_file "USE_CPCLAM" "$USE_CPCLAM"
    echo "Updated CPCLAM repo"
  fi

  if [[ ! -z $SBA_MITRE ]]; then
    update_env_file "SBA_MITRE" "$SBA_MITRE"
    echo "Updated Mitre flag"
  fi

  if [[ ! -z $SBA_AR_FORCE_DETECT ]]; then
    update_env_file "SBA_AR_FORCE_DETECT" "$SBA_AR_FORCE_DETECT"
    echo "Updated ar force detect flag"
  fi

  if [[ ! -z $SBA_OFFLINE_PACKAGE ]]; then
    update_env_file "SBA_OFFLINE_PACKAGE" "$SBA_OFFLINE_PACKAGE"
    echo "Update LA offline package flag"
  fi

  if [[ ! -z $SBA_PRODUCT_UPDATE_DELAY_MIN ]]; then
    update_env_file "SBA_PRODUCT_UPDATE_DELAY_MIN" "$SBA_PRODUCT_UPDATE_DELAY_MIN"
    echo "Updated product update delay flag"
  fi

  if [[ ! -z $SBA_DISABLE_TH_ALERTS ]]; then
    update_env_file "SBA_DISABLE_TH_ALERTS" "$SBA_DISABLE_TH_ALERTS"
    echo "Updated TH alerts flag"
  fi

  if [[ ! -z $SBA_ONACCESS_EVERYTHING ]]; then
    update_env_file "SBA_ONACCESS_EVERYTHING" "$SBA_ONACCESS_EVERYTHING"
    echo "Updated onaccess scan root property"
  fi

  if [[ ! -z $SBA_DEPLPOL_UPDATE_SYSTEMD_TIMING ]]; then
    update_env_file "SBA_DEPLPOL_UPDATE_SYSTEMD_TIMING" "$SBA_DEPLPOL_UPDATE_SYSTEMD_TIMING"
    echo "Updated deployment policy cron update timing"
  fi

  if [[ ! -z $SBA_YARA ]]; then
    update_env_file "SBA_YARA" "$SBA_YARA"
    echo "Updated yara property"
  fi

  if [[ ! -z $SBA_EXPERIMENTAL_BG_RULES ]]; then
    update_env_file "SBA_EXPERIMENTAL_BG_RULES" "$SBA_EXPERIMENTAL_BG_RULES"
    echo "Updated bg experimental rules property"
  fi

  if [[ ! -z $SBA_DUP2_SYSCALL ]]; then
    update_env_file "SBA_DUP2_SYSCALL" "$SBA_DUP2_SYSCALL"
    echo "Updated dup2 syscall property"
  fi

  if [[ ! -z $SBA_DUP3_SYSCALL ]]; then
    update_env_file "SBA_DUP3_SYSCALL" "$SBA_DUP3_SYSCALL"
    echo "Updated dup3 syscall property"
  fi

  if [[ ! -z $SBA_SYSTEMD_REMEDIATION ]]; then
    update_env_file "SBA_SYSTEMD_REMEDIATION" "$SBA_SYSTEMD_REMEDIATION"
    echo "Updated systemd remediation property"
  fi

  if [[ ! -z $SBA_CRONTAB_REMEDIATION ]]; then
    update_env_file "SBA_CRONTAB_REMEDIATION" "$SBA_CRONTAB_REMEDIATION"
    echo "Updated crontab remediation property"
  fi

  if [[ ! -z $SBA_USE_MODERN_BPF_PROBE ]]; then
    update_env_file "SBA_USE_MODERN_BPF_PROBE" "$SBA_USE_MODERN_BPF_PROBE"
    echo "Updated modern bpf probe property"
  fi

  if [[ ! -z $SBA_SEMI_ISOLATED_ENV ]]; then
    update_env_file "SBA_SEMI_ISOLATED_ENV" "$SBA_SEMI_ISOLATED_ENV"
    echo "Updated semi-isolated environment property"
  fi
}

# placeholder function for a custom action to be performed during update
function update_custom_action() {
  # if env file is missing during update write it according to the current environment
  # this is needed if upgrading from script version <= 0.0.14
  if [[ ! -f $g_env_file ]]; then
    write_env_file
  fi
}

function apt_add_public_signature_key() {
  set_repo_type
  local repo_type="$g_repo_type"
  local key_name
  
  if [[ $repo_type == "prod" || $repo_type == "stg" ]]; then
    local repo_fqdn=$g_secureupdates_fqdn
    local key_url="https://${repo_fqdn}/sbalinux/sbalinux-gpg-key.public"
    key_name="sbalinux-${repo_type}"
  elif [[ $repo_type == "dev"  ]]; then
    local repo_fqdn=$g_artifactory_fqdn
    local key_url="https://${repo_fqdn}/artifactory/api/gpg/key/public"
    key_name="sbalinux-dev"
    # add proxy bypass for artifactory
    bypass_proxy ${repo_fqdn}
  else
    echo "invalid repository type: $repo_type"
    exit 1
  fi
  add_gpg_key "$key_url" "$key_name"
}

function import_latest_rpm_repo_key() {
  set_repo_type
  local repo_type="$g_repo_type"
  if [[ $repo_type == "prod" || $repo_type == "stg" ]]; then
    local repo_fqdn=$g_secureupdates_fqdn
    local key_url="https://${repo_fqdn}/sbalinux/sbalinux-gpg-key.asc"
  elif [[ $repo_type == "dev" ]]; then
    local repo_fqdn=$g_artifactory_fqdn
    local key_url="https://${repo_fqdn}/artifactory/SBA_GEN/repo_public_keys/rpm/sbalinux-gpg-key.asc"
    # add proxy bypass for artifactory
    bypass_proxy $repo_fqdn
  else
    echo "invalid repository type: $repo_type"
    exit 1
  fi
  rpm --import $key_url
}

function do_update_from_repo() {
  if [[ $g_package_type == "deb" ]]; then
    if [[ ! -f $g_deb_repo_config_file && -z "$g_force_no_sbalinux_repo" ]]; then
      echo "sbalinux debian repository not defined"
      exit 1
    fi
    apt_add_public_signature_key
    update_deb_pkg_from_repo
  elif [[ $g_package_type == "rpm" ]]; then
    if [[ ! -f $g_rpm_repo_config_file && -z "$g_force_no_sbalinux_repo" ]]; then
      echo "sbalinux rpm repository not defined"
      exit 1
    fi
    import_latest_rpm_repo_key
    update_rpm_pkg_from_repo
  fi
  if [[ $g_client_updated == "yes" ]]; then
    set_cpla_required_products "${g_blades[@]}"
  fi
  # do a custom action
  update_custom_action
  # rewrite update timer script file in case they need to be updated
  schedule_or_remove_update_systemd_timer
}

function update_deb_pkg_from_repo() {
  local is_old_pkg
  is_old_pkg=$(is_deb_pkg_installed "$g_old_pkg_name"; echo $?)

  local version_str=""
  if [[ -n $g_version_to_install ]]; then
    version_str="=${g_version_to_install}"
  fi

  apt-get update
  if [ "$is_old_pkg" -eq 0 ]; then
    apt-get install -y "${g_pkg_name}${version_str}"
  else
    local output=$(LANG=C apt-get install -y --only-upgrade "${g_pkg_name}${version_str}")
    echo "$output"
    if ! echo "$output" | grep -q "^0 upgraded" ; then
      g_client_updated="yes"
    fi
  fi
}

function update_rpm_pkg_from_repo() {
  local is_old_pkg
  is_old_pkg=$(is_rpm_pkg_installed "$g_old_pkg_name"; echo $?)

  # backup configs during update from cpsba-la to cpsba-sbox
  [ "$is_old_pkg" -eq 0 ] && cp /etc/checkpoint/cpla/*-config.json "$g_upgrade_conf_dir"

  if is_suse ; then
    zypper -n refresh
    if [ "$is_old_pkg" -eq 0 ]; then
      # zypper can return ZYPPER_EXIT_INF_RPM_SCRIPT_FAILED, perhaps because of clam
      # however, the packages are removed and this is ok to ignore this exit code
      zypper -n rm "${g_old_pkg_name}" || [[ $? -eq 107 ]]
      zypper -n in "${g_pkg_name}"
    else
      local output=$(LANG=C zypper -n up "${g_pkg_name}")
      echo "$output"
      if ! echo "$output" | grep -qP "^Nothing to do" ; then
        g_client_updated="yes"
      fi
    fi
  else
    if [[ -n $g_version_to_install ]]; then
      local pkg_name=${g_pkg_name}-${g_version_to_install}
      yum install -y "$pkg_name"
    else
      if [ "$is_old_pkg" -eq 0 ]; then
        yum remove -y "${g_old_pkg_name}"
        yum install -y "${g_pkg_name}"
      else
        local output=$(LANG=C yum update -y "${g_pkg_name}")
        echo "$output"
        if echo "$output" | grep -A 1 "Upgraded:" | grep -q "${g_pkg_name}" ; then
          g_client_updated="yes"
        fi
      fi
    fi
  fi


  # return configs after update from cpsba-la to cpsba-sbox
  if [ "$is_old_pkg" -eq 0 ]; then
    mkdir -p /etc/checkpoint/cpla
    cp "$g_upgrade_conf_dir"/* /etc/checkpoint/cpla/
  fi
}

function store_config_dat_file() {
  if [[ ! -z $g_da_config_dat_content ]]; then
    mkdir -p $g_da_config_dat_base_path
    echo $g_da_config_dat_content >$g_da_config_dat_file
  fi
}

# write ca cert and sig file from base64 encoded external arguments
function write_ca_cert_and_sig() {
  if [[ ! -z $g_mgmt_ca_cert_data_base64 && ! -z $g_mgmt_ca_cert_sig_data_base64 ]]; then
    mkdir -p $g_ca_cert_base_path
    echo $g_mgmt_ca_cert_data_base64 | base64 --decode >$g_ca_cert_file
    echo $g_mgmt_ca_cert_sig_data_base64 | base64 --decode >$g_ca_cert_sig_file
  fi
}

function remove_ca_cert_and_sig() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    rm -f $g_ca_cert_file
    rm -f $g_ca_cert_sig_file
    set +e
    rm -df $g_ca_cert_base_path
    set -e
  fi
}

function migrate_systemd_conf_to_env_file() {
  local env_file="/etc/checkpoint/cpla/env"
  if [ -e "$g_la_conf_file_path" ] && [ ! -e "$env_file" ]; then
    cp "$g_la_conf_file_path" "$env_file"
    # remove 1st line with '[Service]' and 'Environment=' with quotes
    sed -i -e '1d' -e 's/^Environment="//' -e 's/"$//g' "$env_file"
    set -o allexport; source "$env_file" ; set +o allexport
  fi
}

function remove_repo_file() {
  if [[ $g_package_type == "deb" ]]; then
    rm -f "${g_deb_repo_config_file}"
  elif [[ $g_package_type == "rpm" ]]; then
    if [ -f "${g_rpm_repo_config_file}" ]; then
      rm -f "${g_rpm_repo_config_file}"
    fi
  fi
}

# when exit code trap occurs, display fail message if exit code > 0
function show_exit_code_trap_error() {
  if (($? > 0)); then
    echo "The $g_operation operation failed! ($(date))"
    if [[ $g_operation == "install" ]]; then
      remove_repo_file
      [ -n "$SBA_OFFLINE_PACKAGE" ] && ensure_offline_repo_dir_removed

      if [[ $g_install_with_systemd_timer == 'yes' ]]; then
        echo "Another installation attempt was scheduled. It will be started by systemd in 30 minutes ($g_systemd_install_timer_name)"
      fi

    fi
  fi
  ensure_upgrade_conf_dir_removed
  ensure_bootstrap_dir_removed
}

# set traps for exit code and ctrl-c to display fail message
function set_trap() {
  trap exit 1 SIGINT
  trap show_exit_code_trap_error EXIT
}

function start_service() {
  local unit_name=$1
  echo "Starting ${unit_name} service"
  systemctl start $unit_name
  # TODO: remove '|| true' after centos_9 installation works
  # without 'Invalid cross-device link' error which doesn't affect cpla service
  systemctl enable $unit_name || true
}

function stop_service() {
  local unit_name=$1
  if systemctl is-active --quiet $unit_name; then
    echo "Stopping ${unit_name} service"
    systemctl stop $unit_name
  fi
  systemctl disable $unit_name
}

function uninstall_all() {
  # if run uninstall with no arguments, i.e. uninstall all
  local ginstalled
  ginstalled=$(echo "$g_uninstall_product" | xargs)
  local gdefault="${g_default_blades_set},fim"
  if [[ "$ginstalled" == "$gdefault" ]] ; then
    echo "yes"
  else
    echo "no"
  fi
}

function set_cpla_required_products() {
  echo "Setting cpla blades list"
  local products=("$@")
  local cmdline=""
  for product in ${products[*]}; do
    blade=${g_prod_to_blade[$product]}
    cmdline="$cmdline -b $blade"
  done
  $g_cpla_path set_required_blades $cmdline
}

function is_deb_pkg_installed() {
  [[ $(dpkg-query -W -f='${Status}' "$1" 2>&1) == 'install ok installed' ]]
}

function is_rpm_pkg_installed() {
  rpm -q "$1" >/dev/null 2>&1
}

function do_update() {
  set_blades_from_products $g_update_product
  # inject "ar" blade if previous installation didn't do it and not only specific blade is requested
  if [[ ! -f $g_ar_injected_flag ]]; then
      if [[ ${#g_blades[@]} -gt 1 && ! "${g_blades[@]}" =~ "ar" ]]; then
          g_blades+=("ar")
      fi
      touch $g_ar_injected_flag
  fi

  # inject "efr" blade if previous installation didn't do it and not only specific blade is requested
  if [[ ! -f $g_efr_injected_flag ]]; then
      if [[ ${#g_blades[@]} -gt 1 && ! "${g_blades[@]}" =~ "efr" ]]; then
          g_blades+=("efr")
      fi
      touch $g_efr_injected_flag
  fi

  # check audit compatibility in case AM or AR need to be updated,
  # or update to version that at least contains tool to check compatibility
  if [[ "${g_blades[@]}" =~ "am" || "${g_blades[@]}" =~ "ar" ]]; then
    verify_am_compatibility 0
  fi

  if [[ $g_package_type == "deb" ]]; then
      set_repo_type
      configure_deb_repo $g_repo_type
  elif [[ $g_package_type == "rpm" ]]; then
      set_repo_type
      configure_rpm_repo $g_repo_type
  fi

  do_update_from_repo

  echo "Installing all blades dependencies of Linux Agent"
  $g_cpla_path install_all
}

function verify_am_compatibility() {
  local need_cleanup=$1
  set +e
  $g_cpla_path check-audit-compat
  local exit_code=$?
  set -e

  # exit code is 1 - fail installation
  if [[ $exit_code -eq 1 ]]; then
    if [[ $need_cleanup -eq 1 ]]; then
      do_uninstall
      remove_install_systemd_job
      trap "" EXIT
    fi
    echo "Unable to install Anti Malware. Please contact support."
    exit 1
  fi

  # exit code is 2 - set reboot flag
  if [[ $exit_code -eq 2 ]]; then
    tty -s && g_need_reboot=1 || g_need_reboot=2
  fi

  echo "Anti Malware compatibility check completed"
}

# workaround in case installation start in systemd timer which may set default PATH env to "/usr/bin:/bin"
# or "/bin:/usr/bin" on some systems (e.g. ubuntu_18)
# this PATH is insufficient and makes apt fail during upgrade (can't find ldconfig and other binaries)
function enforce_path_env() {
  if [ "$PATH" = "/bin:/usr/bin" ] || [ "$PATH" = "/usr/bin:/bin" ]; then
    export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  fi
}

function enable_install_log_file() {
  mkdir -p "$g_log_base_path"
  exec &> >(tee -a "${g_install_log_file}")
}

function set_install_products_from_blade_mask() {
  local blade_mask="$1"

  if [ "$blade_mask" -eq 65 ]; then
    g_remote_install_products="am"
  elif [ "$blade_mask" -eq 65601 ]; then
    g_remote_install_products="am,bg,edr,ar,efr"
  else
    echo "invalid value for blade mask ($blade_mask), ignoring it"
  fi
}

function create_da_storage_path() {
  mkdir -p "$g_da_storage_path"
}

function remove_da_storage_path() {
  if [[ -d "$g_da_storage_path" ]]; then
    rm -rf "$g_da_storage_path"
  fi
}

# Backup DA storage to temporary folder
function backup_da_storage() {
  if [[ -d "$g_da_storage_path" ]]; then
    echo "backing up DA storage: '$g_da_storage_path' -> '$g_da_storage_backup_path'"
    rm -rf "$g_da_storage_backup_path"
    mkdir -p "$g_da_storage_backup_path"
    cp -a "$g_da_storage_path"/* "$g_da_storage_backup_path/" || true
    echo "DA storage backup completed"
  else
    echo "DA storage directory '$g_da_storage_path' does not exist, skipping backup"
  fi
}

# Restore DA storage from temporary folder
function restore_da_storage() {
  if [[ -d "$g_da_storage_backup_path" ]]; then
    echo "restoring DA storage: '$g_da_storage_backup_path' -> '$g_da_storage_path'"
    mkdir -p "$g_da_storage_path"
    cp -a "$g_da_storage_backup_path"/* "$g_da_storage_path/" || true
    echo "DA storage restore completed"
  else
    echo "DA storage backup directory '$g_da_storage_backup_path' does not exist, skipping restore"
  fi
}

# Cleanup DA storage backup folder
function cleanup_da_storage_backup() {
  if [[ -d "$g_da_storage_backup_path" ]]; then
    echo "cleaning up DA storage backup from '$g_da_storage_backup_path'"
    rm -rf "$g_da_storage_backup_path"
  fi
}

function apply_supernode_default_policy() {
  if [[ -n "$SBA_SEMI_ISOLATED_ENV" ]]; then
    if is_valid_embedded_arg "$EMBEDDED_DEFAULT_POLICY"; then
      echo "super_node: found default policies"
      local tmpdir
      tmpdir=$(mktemp -d)
      if [[ -d $tmpdir ]]; then
        extract_default_policy "$EMBEDDED_DEFAULT_POLICY" "$tmpdir"
        convert_supernode_policies "$tmpdir" $g_da_storage_path
        rm -rf "$tmpdir"
      else
        echo "super_node: failed to create temporary directory"
        return 1
      fi
    else
      echo "super_node: no default policies"
      return 1
    fi
  fi
  return 0
}

function extract_default_policy() {
  local encoded_data=$1
  local target_dir=$2
  echo "$encoded_data" | base64 -d | tar -C "$target_dir" -xz
  echo "super_node: extracted default policies to $target_dir"
}

function convert_supernode_policies() {
  local src_dir=$1
  local da_storage_path=$2
  local needed_policies=(
    "401"
  )
  
  local json_content="{\"blade_policies\":["

  SAVEIFS=$IFS
  IFS=$(printf '\n\t')
  for info_file in "$src_dir"/default_policies/{Common,Default}/*_info.cppol; do
    info=$(tr -d '\0' < "$info_file")
    if [[ $info =~ type=\"([0-9]+)\"[[:space:]]+pac=\"([0-9]+)\"[[:space:]]+id=\"([0-9a-zA-Z-]+)\"[[:space:]]+modDate=\"([0-9]+)\" ]]; then
      type=${BASH_REMATCH[1]}
      pac=${BASH_REMATCH[2]}
      id=$(to_lower ${BASH_REMATCH[3]})
      modDate=${BASH_REMATCH[4]}
      
      for ntype in "${needed_policies[@]}" ; do
        if [ "$ntype" == "$type" ] && [ "$pac" == "1" ]; then
          echo "super_node: processing policy - type: $type pac: $pac id: $id mod_date: $modDate"
          local content_file=${info_file//_info.cppol/_content.cppol}
          if [[ -f $content_file ]]; then
            json_content+="{\"id\":\"$id\",\"mod_date\":\"$modDate\",\"pac\":\"$pac\",\"type\":$type},"
            cp "$content_file" "${da_storage_path}/"
            content_file_base_name=$(basename "$content_file")
            target_file_base_name="${type}_${pac}.dat"
            mv "${da_storage_path}/${content_file_base_name}" "${da_storage_path}/${target_file_base_name}"
            echo "super_node: $content_file_base_name -> $target_file_base_name"
          fi
        fi
      done
    fi
  done
  IFS=$SAVEIFS

  json_content=${json_content::-1}
  json_content+="]}"
  echo "$json_content" > "${da_storage_path}/da_registry.json"
  echo "super_node: created registry file"
}

if [[ $# -eq 1 && $1 == "--help" ]]; then
  version_str="<developer version>"
  if [[ $SCRIPT_VER =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    version_str="v$SCRIPT_VER"
  fi
  echo "Check Point Sandblast Agent for Linux Installer $version_str"
  echo "Usage: sudo $0 <install|uninstall|config> [options]"
  echo ""
  echo "Possible operations:"
  echo "   install:   install a product"
  echo "   uninstall: uninstall a product"
  echo "   config:    update configuration for an already installed product"
  echo ""
  echo "Options for 'install' operation:"
  echo "  --source <remote|local>             Installation source (default: remote)"
  echo "      remote                          Install from remote package repository"
  echo "      local                           Install from local package file"
  echo "  --product <product>                 Specify product to install, possible products: edr,am (default: both products are installed)"
  echo "                                      Use only if installing from remote package repository"
  echo "  --file_name <file name>             Package file name to install. Use only if installing from local package file"
  echo "  --version <version>                 Product version to install (default: latest). Use only if installing from remote package repository"
  echo "  --url <url>                         Management server url"
  echo "  --key <key>                         Management server key"
  echo "  --http_proxy <url>                  HTTP proxy url"
  echo "  --https_proxy <url>                 HTTPS proxy url"
  echo "  --no_proxy <urls|none|ALL>          bypass proxy for these urls. 'none' leaves the list empty, 'ALL' discards all proxy configuration"
  echo "  --retry <yes|no>                    Schedule another installation attempt if first attempt failed, default: yes"
  echo "  --debug                             Enable debug logging for the client"
  echo "  --selfhealing                       Enable client self-recovery"
  echo "  --auth_principal  <principal>       auth principal which was set up for AD authentication. E.g. krbsvc/sba.com@SBA.COM"
  echo "  --group  <group-guid>               id of virtual directory to put the client into"
  echo ""
  echo "Options for 'uninstall' operation:"
  echo "  --product <product>                 Specify product to uninstall, possible products: edr,am"
  echo ""
  echo "Options for 'config' operation:"
  echo "  --url <url>                         Update management server url"
  echo "  --key <key>                         Update management server key"
  echo "  --http_proxy <url|none>             Update HTTP proxy url. Use 'none' to specify no proxy"
  echo "  --https_proxy <url|none>            Update HTTPS proxy url. Use 'none' to specify no proxy"
  echo "  --no_proxy <urls|none|ALL>          bypass proxy for these urls. Use 'none' for empty list, ',' as delimiter"
  echo "                                      Passing 'ALL' will clear all proxy configuration"
  echo "  --auth_principal  <principal>       auth principal which was set up for AD authentication. E.g. krbsvc/sba.com@SBA.COM"
  echo ""
  exit 0
fi

# exported variable to be used by each product package scripts
# by default pick proxy settings from the environment

export HTTP_PROXY=${HTTP_PROXY:=""}
export HTTPS_PROXY=${HTTPS_PROXY:=""}
export NO_PROXY=${NO_PROXY:=""}
export SBA_MANAGEMENT_KEY=""
export SBA_MANAGEMENT_URL=""
export SBA_CONFIG_DAT_FILE=${SBA_CONFIG_DAT_FILE:=""}
export SBA_ENABLE_BG=${SBA_ENABLE_BG:=""}
export SBA_FORCE_DISTRO=${SBA_FORCE_DISTRO:=""}
export SBA_AUTH_PRINCIPAL=${SBA_AUTH_PRINCIPAL:=""}
export SBA_USE_DA=${SBA_USE_DA:=""}
export SBA_MITRE=${SBA_MITRE:=""}
export SBA_AR_FORCE_DETECT=${SBA_AR_FORCE_DETECT:=""}
export USE_CPCLAM=${USE_CPCLAM:=""}
export SBA_VDS_LOCATION_GUID=${SBA_VDS_LOCATION_GUID:=""}
# do not use SBA_OFFLINE_PACKAGE from env
# script should figure out whether it's offline or not by itself
export SBA_OFFLINE_PACKAGE=""
export SBA_PRODUCT_UPDATE_DELAY_MIN=${SBA_PRODUCT_UPDATE_DELAY_MIN:=""}
export SBA_DISABLE_TH_ALERTS=${SBA_DISABLE_TH_ALERTS:=""}
export SBA_ONACCESS_EVERYTHING=${SBA_ONACCESS_EVERYTHING:=""}
export SBA_DEPLPOL_UPDATE_SYSTEMD_TIMING=${SBA_DEPLPOL_UPDATE_SYSTEMD_TIMING:=""}
export SBA_YARA=${SBA_YARA:=""}
export SBA_EXPERIMENTAL_BG_RULES=${SBA_EXPERIMENTAL_BG_RULES:=""}
export SBA_DUP2_SYSCALL=${SBA_DUP2_SYSCALL:=""}
export SBA_DUP3_SYSCALL=${SBA_DUP3_SYSCALL:=""}
export SBA_SYSTEMD_REMEDIATION=${SBA_SYSTEMD_REMEDIATION:=""}
export SBA_CRONTAB_REMEDIATION=${SBA_CRONTAB_REMEDIATION:=""}
export SBA_USE_MODERN_BPF_PROBE=${SBA_USE_MODERN_BPF_PROBE:=""}
# SBA_SEMI_ISOLATED_ENV should be enabled by default in the context of the install script to process default policy
export SBA_SEMI_ISOLATED_ENV=${SBA_SEMI_ISOLATED_ENV:="1"}

g_package_type=""
g_distro_name=""
g_distro_version=""
g_rpm_repo_config_file=""

# CA cert and signature
g_mgmt_ca_cert_data_base64=""
g_mgmt_ca_cert_sig_data_base64=""
g_ca_cert_base_path="/var/lib/checkpoint/cpmgmt"
g_ca_cert_file="${g_ca_cert_base_path}/server.crt"
g_ca_cert_sig_file="${g_ca_cert_base_path}/server.crt.sig"

# DA config.dat
g_da_config_dat_content=""
g_da_config_dat_base_path="/var/lib/checkpoint/da"
g_da_config_dat_file="${g_da_config_dat_base_path}/config.dat"

# DA storage path
g_da_storage_path="/var/cache/checkpoint/da"
g_da_storage_backup_path="/tmp/cpla_da_bkp"

g_install_source="remote"
# flag to indicate that products to install from remote repo were given by the user
g_got_remote_install_product_arg=0
g_efr_injected_flag=/etc/checkpoint/.efr_injected

if [[ $ARCH == "x86_64" ]]; then
  g_default_blades_set="edr,am,bg,ar,efr"
else
  g_default_blades_set="am,ar"
fi

# reboot status: 0 - not required, 1 - required in interactive mode, 2 - required in non-interactive mode
g_need_reboot=0
g_ar_injected_flag=/etc/checkpoint/.ar_injected

g_remote_install_products=${g_default_blades_set}
g_local_install_file_name=""
g_repo_type="prod"
g_uninstall_product="${g_default_blades_set},fim"
g_update_product=${g_default_blades_set}
g_client_updated="no"

# products requested to be installed or uninstalled
g_blades=()
# products actually installed
g_installed_products=()
# specific product version to install
g_version_to_install=""

# These timings are given in systemd OnCalendar format
g_systemd_update_timing=${SBA_UPDATE_SYSTEMD_TIMING:="hourly"}
g_systemd_install_timing=${SBA_INSTALL_SYSTEMD_TIMING:="*-*-* *:00/30:00"}


g_log_base_path="/var/log/checkpoint/common"
g_install_log_file="${g_log_base_path}/sbalinux-install.log"
g_update_log_file="${g_log_base_path}/sbalinux-update.log"
g_switch_repo_log_file="${g_log_base_path}/sbalinux-product-update.log"

g_should_schedule_upgrade="yes"
g_legacy_update_cron_file_path="/etc/cron.d/sbalinux-update"
g_systemd_update_job_name="sbalinux-update"
g_systemd_update_unit_path="/etc/systemd/system/${g_systemd_update_job_name}.service"
g_systemd_update_timer_path="/etc/systemd/system/${g_systemd_update_job_name}.timer"
g_systemd_product_update_name="sbalinux-product-update"
g_systemd_product_update_unit_path="/etc/systemd/system/${g_systemd_product_update_name}.service"
g_systemd_product_update_timer_path="/etc/systemd/system/${g_systemd_product_update_name}.timer"
g_cron_file_switch_repo_path="/etc/cron.d/sbalinux-product-update"

g_install_with_systemd_timer="yes"
g_systemd_install_job_name="sbalinux-install"
g_systemd_install_unit_name="${g_systemd_install_job_name}.service"
g_systemd_install_timer_name="${g_systemd_install_job_name}.timer"
g_systemd_install_unit_path="/etc/systemd/system/${g_systemd_install_unit_name}"
g_systemd_install_timer_path="/etc/systemd/system/${g_systemd_install_timer_name}"

g_la_conf_file_path="/etc/systemd/system/cpla.service.d/cpla.conf"
# for testing: systemctl show --property=Environment <service>

g_args="${@}"

g_deb_repo_config_file="/etc/apt/sources.list.d/sbalinux.list"

g_secureupdates_fqdn="secureupdates.checkpoint.com"
g_artifactory_fqdn="artifactory-npm.checkpoint.com"

# folder to save helper scripts generated for the update process
g_save_folder="/etc/checkpoint/common"
# path to saved install script used for timer updates
g_saved_script="${g_save_folder}/install.sh"
# env file path
g_env_file="${g_save_folder}/sbalinux.env"
# package name for installer updates
g_installer_package_name="cpsba-install"
g_cpla_path="/usr/bin/cpla"
# package names
g_pkg_name="cpsba-sbox"
g_old_pkg_name="cpsba-la"
# map product name to cpla blade name
declare -A g_prod_to_blade
g_prod_to_blade['am']="AM"
g_prod_to_blade['edr']="SBA"
g_prod_to_blade['bg']="BG"
g_prod_to_blade['fim']="FIM"
g_prod_to_blade['ar']="AR"
g_prod_to_blade['efr']="EFR"

g_upgrade_conf_dir=$(mktemp -d)
g_force_no_sbalinux_repo=""
# offline_package related variables
g_offline_repo_path="/var/lib/checkpoint/sbalinux_offline"
g_bootstrap_dir=
# leave configs/logs/etc after removal, don't notify mgmt
# during deployment policy handling to switch online/offline package
g_switching_repo=0
# universal repo name
g_universal_repo="universal"


# parse args
g_operation=${1:-""}
if [[ -z $g_operation ]]; then
  echo "operation not defined, for usage run: $0 --help"
  exit 1
fi
shift

# apply valid external arguments so they can serve as defaults
apply_embedded_arguments

# parse command line arguments
set +e

if [[ $g_operation == "install" ]]; then
  while (($#)); do
    if [[ $1 == "--http_proxy" ]]; then
      shift
      export HTTP_PROXY=${1:-""}
      export http_proxy=${1:-""}
    elif [[ $1 == "--https_proxy" ]]; then
      shift
      export HTTPS_PROXY=${1:-""}
      export https_proxy=${1:-""}
    elif [[ $1 == "--no_proxy" ]]; then
      shift
      export NO_PROXY=${1:-""}
      export no_proxy=${1:-""}
      if [[ $1 == "ALL" ]]; then
        export HTTP_PROXY=""
        export HTTPS_PROXY=""
        export NO_PROXY=""
        export http_proxy=""
        export https_proxy=""
        export no_proxy=""
      fi
    elif [[ $1 == "--key" ]]; then
      shift
      export SBA_MANAGEMENT_KEY=${1:-""}
    elif [[ $1 == "--url" ]]; then
      shift
      export SBA_MANAGEMENT_URL=${1:-""}
    elif [[ $1 == "--source" ]]; then
      shift
      g_install_source=${1:-""}
    elif [[ $1 == "--product" ]]; then
      shift
      g_remote_install_products=${1:-""}
      g_got_remote_install_product_arg=1
    elif [[ $1 == "--file_name" ]]; then
      shift
      g_local_install_file_name=${1:-""}
    elif [[ $1 == "--version" ]]; then
      shift
      g_version_to_install=${1:-""}
    elif [[ $1 == "--retry" ]]; then
      shift
      g_install_with_systemd_timer=${1:-""}
    elif [[ $1 == "--debug" ]]; then
      export SBA_LOG_LEVEL=DEBUG
      shift
    elif [[ $1 == "--selfhealing" ]]; then
      export SBA_SELF_HEALING=1
      shift
    elif [[ $1 == "--auth_principal" ]]; then
      shift
      export SBA_AUTH_PRINCIPAL=${1:-""}
    elif [[ $1 == "--group" ]]; then
      shift
      export SBA_VDS_LOCATION_GUID=${1:-""}
    elif [[ $1 == "--upgrade" ]]; then
      shift
      g_should_schedule_upgrade=${1:-""}
    elif [[ $1 == "--stg" ]]; then
      shift
      export SBA_REPO_TYPE=stg
    # Just for the SIPLEC, do not pre-configure sbalinux repo
    elif [[ $1 == "--satellite" ]]; then
      g_force_no_sbalinux_repo=${1:-""}
      shift
    else
      echo "invalid argument $1"
      exit 1
    fi
    shift
  done
elif [[ $g_operation == "config" ]]; then
  num_of_config_args=0
  # dont inherit anything from the environment
  HTTP_PROXY=""
  HTTPS_PROXY=""
  NO_PROXY=""
  SBA_MANAGEMENT_KEY=""
  SBA_MANAGEMENT_URL=""
  SBA_AUTH_PRINCIPAL=""

  while (($#)); do
    if [[ $1 == "--http_proxy" ]]; then
      shift
      export HTTP_PROXY=${1:-""}
    elif [[ $1 == "--https_proxy" ]]; then
      shift
      export HTTPS_PROXY=${1:-""}
    elif [[ $1 == "--no_proxy" ]]; then
      shift
      export NO_PROXY=${1:-""}
      if [[ $1 == "ALL" ]]; then
        export HTTP_PROXY="none"
        export HTTPS_PROXY="none"
        export NO_PROXY="none"
      fi
    elif [[ $1 == "--key" ]]; then
      shift
      export SBA_MANAGEMENT_KEY=${1:-""}
    elif [[ $1 == "--url" ]]; then
      shift
      export SBA_MANAGEMENT_URL=${1:-""}
    elif [[ $1 == "--auth_principal" ]]; then
      shift
      export SBA_AUTH_PRINCIPAL=${1:-""}
    else
      echo "invalid argument $1"
      exit 1
    fi
    [[ -z ${1:-""} ]] && echo "missing value for config option" && exit 1 || (( num_of_config_args++ ))
    shift
  done
elif [[ $g_operation == "uninstall" ]]; then
  while (($#)); do
    if [[ $1 == "--product" ]]; then
      shift
      g_uninstall_product=${1:-""}
    elif [[ $1 == "--switching-repo" ]]; then
      shift
      g_switching_repo=1
    else
      echo "invalid argument $1"
      exit 1
    fi
    shift
  done

elif [[ $g_operation == "update" ]]; then
  while (($#)); do
    if [[ $1 == "--product" ]]; then
      shift
      g_update_product=${1:-""}
    elif [[ $1 == "--satellite" ]]; then
      shift
      g_force_no_sbalinux_repo=${1:-""}
    elif [[ $1 == "--version" ]]; then
      shift
      g_version_to_install=${1:-""}
    else
      echo "invalid argument $1. Use update without arguments or with --product <am,edr,bg>"
      exit 1
    fi
    shift
  done
else
  echo "invalid operation '${g_operation}', valid operations are 'install', 'uninstall'"
  exit 1
fi

set -e

enforce_path_env

# detect distribution and package time
detect_package_type
if [[ -z $g_package_type ]]; then
  echo "Unsupported distribution or architecture"
  exit 1
fi

# main
if [[ $g_operation == "install" ]]; then
  enable_install_log_file
  check_offline_package
  check_install_cmd_args
  check_umask
  force_env_vars
  set_trap

  find_installed_products
  [ -n "$SBA_OFFLINE_PACKAGE" ] && prepare_offline_package
  if ((${#g_installed_products[@]} == 0)); then
    if [[ $g_install_source == "remote" || -n "$SBA_OFFLINE_PACKAGE" ]] ; then
      if [ -n "$SBA_OFFLINE_PACKAGE" ]; then
        echo "Offline install"
      else
        echo "Remote install"
      fi
      do_remote_install
    elif [[ $g_install_source == "local" ]]; then
      echo "Local install"
      do_file_install
    else
      echo "invalid install source mode"
      exit 1
    fi
  else
    echo "cpla is already installed, set of blades will be updated."
    stop_service "cpla"
    set_blades_from_products $g_remote_install_products
    enable_bg_coupled_blades
  fi

  # let know to futher updates that this script was able to install "ar" if needed
  # so updater no need inject "ar" blade to product
  touch $g_ar_injected_flag

  # let know to further updates that this script was able to install "efr" if needed
  # so updater no need to inject "efr" blade into product
  touch $g_efr_injected_flag

  # check audit compatibility in case AM need to be installed
  if [[ "${g_blades[@]}" =~ "am" || "${g_blades[@]}" =~ "ar" ]]; then
    verify_am_compatibility 1
  fi

  set_cpla_required_products "${g_blades[@]}"

  echo "Installing all blades dependencies of Linux Agent"
  $g_cpla_path install_all
  
  # Apply supernode default policy.
  set +e
  create_da_storage_path
  apply_supernode_default_policy
  result=$?
  set -e
  
  # Attempt to restore DA storage from backup if no embedded default policy is available.
  # This should handle a case where DA storage folder was deleted during offline package upgrade sequence.
  if [[ $result -ne 0 ]]; then
    echo "apply_supernode_default_policy failed, restoring DA storage backup if available"
    restore_da_storage
  fi
  cleanup_da_storage_backup
  
  start_service "cpla"
  
  if [[ $g_need_reboot == 1 ]]; then
    echo "Rebooting the system"
    reboot
  elif [[ $g_need_reboot == 2 ]]; then
    echo "Reboot is required"
  fi

elif [[ $g_operation == "uninstall" ]]; then
  echo "Uninstall all: $(uninstall_all)"
  set_trap
  set_blades_from_products $g_uninstall_product
  stop_service cpla
  current_blades=$($g_cpla_path get_required_blades)
  echo "Blades installed in cpla: $current_blades"
  for product in ${g_blades[*]}; do
    echo "Deleting ${g_prod_to_blade["$product"]} blade"
    set +e
    $g_cpla_path uninstall_blade -b ${g_prod_to_blade["$product"]}
    set -e
  done
  current_blades=$($g_cpla_path get_required_blades)

  if [[ (-z "$current_blades" || "$current_blades" = "Blades: ") && "$(uninstall_all)" == "yes" ]] ; then
    do_uninstall
  else
    $g_cpla_path install_all
    echo "CPLA still contain installed blades $current_blades"
    start_service cpla
  fi
elif [[ $g_operation == "config" ]]; then
  check_config_cmd_args
  set_trap
  do_config
  echo "Restarting cpla service"
  systemctl restart cpla
elif [[ $g_operation == "update" ]]; then
  migrate_systemd_conf_to_env_file
  set_trap
  do_update
  start_service "cpla"
fi

echo $'\n'"The $g_operation operation completed successfully ($(date))"

exit 0